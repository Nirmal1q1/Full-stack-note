<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotesApp - Full-Stack Note Taking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #475569;
        }
        
        .light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border: #e2e8f0;
        }
        
        .theme-bg-primary { background-color: var(--bg-primary); }
        .theme-bg-secondary { background-color: var(--bg-secondary); }
        .theme-bg-tertiary { background-color: var(--bg-tertiary); }
        .theme-text-primary { color: var(--text-primary); }
        .theme-text-secondary { color: var(--text-secondary); }
        .theme-border { border-color: var(--border); }
        
        .note-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .note-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.25),
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        /* 3D Input Styles */
        .input-3d {
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .input-3d:focus {
            outline: none;
            transform: translateY(-2px);
            box-shadow: 
                0 10px 15px -3px rgba(102, 126, 234, 0.3),
                0 4px 6px -2px rgba(102, 126, 234, 0.2),
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 3px rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .input-3d:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 6px 8px -1px rgba(0, 0, 0, 0.15),
                0 3px 5px -1px rgba(0, 0, 0, 0.08),
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.15);
        }
        
        /* Textarea 3D Styles */
        .textarea-3d {
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 -2px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .textarea-3d:focus {
            outline: none;
            transform: translateY(-2px);
            box-shadow: 
                0 15px 25px -5px rgba(102, 126, 234, 0.3),
                0 8px 10px -5px rgba(102, 126, 234, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 -2px 0 rgba(255, 255, 255, 0.2),
                0 0 0 3px rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .textarea-3d:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 8px 10px -3px rgba(0, 0, 0, 0.15),
                0 4px 6px -2px rgba(0, 0, 0, 0.08),
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 -2px 0 rgba(255, 255, 255, 0.15);
        }
        
        /* Button 3D Styles */
        .button-3d {
            background: linear-gradient(145deg, #7c3aed, #5b21b6);
            border: none;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .button-3d:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 10px 15px -3px rgba(124, 58, 237, 0.4),
                0 4px 6px -2px rgba(124, 58, 237, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }
        
        .button-3d:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 4px -1px rgba(0, 0, 0, 0.2),
                0 1px 2px -1px rgba(0, 0, 0, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Select 3D Styles */
        .select-3d {
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        .select-3d:focus {
            outline: none;
            transform: translateY(-2px);
            box-shadow: 
                0 10px 15px -3px rgba(102, 126, 234, 0.3),
                0 4px 6px -2px rgba(102, 126, 234, 0.2),
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 3px rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .select-3d:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 6px 8px -1px rgba(0, 0, 0, 0.15),
                0 3px 5px -1px rgba(0, 0, 0, 0.08),
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.15);
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #667eea, #764ba2);
            border-radius: 4px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #5a67d8, #6b46c1);
        }
        
        /* Smooth animations for all interactive elements */
        * {
            scroll-behavior: smooth;
        }
        
        /* Enhanced focus rings */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        /* Ripple effect for buttons */
        .button-3d::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .button-3d:active::before {
            width: 300px;
            height: 300px;
        }
        
        .auth-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        /* 3D Background Styles */
        .background-3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -10;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            pointer-events: none;
        }
        
        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .shape {
            position: absolute;
            opacity: 0.3;
            animation: float 20s infinite linear;
            will-change: transform;
        }
        
        .shape:nth-child(1) {
            left: 10%;
            animation-delay: 0s;
            animation-duration: 25s;
        }
        
        .shape:nth-child(2) {
            left: 20%;
            animation-delay: -5s;
            animation-duration: 30s;
        }
        
        .shape:nth-child(3) {
            left: 35%;
            animation-delay: -10s;
            animation-duration: 20s;
        }
        
        .shape:nth-child(4) {
            left: 50%;
            animation-delay: -15s;
            animation-duration: 35s;
        }
        
        .shape:nth-child(5) {
            left: 65%;
            animation-delay: -20s;
            animation-duration: 25s;
        }
        
        .shape:nth-child(6) {
            left: 80%;
            animation-delay: -25s;
            animation-duration: 40s;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg) scale(0.5);
                opacity: 0.2;
            }
            10% {
                opacity: 0.3;
                transform: translateY(90vh) rotate(36deg) scale(0.8);
            }
            50% {
                opacity: 0.4;
                transform: translateY(50vh) rotate(180deg) scale(1);
            }
            90% {
                opacity: 0.3;
                transform: translateY(10vh) rotate(324deg) scale(0.8);
            }
            100% {
                transform: translateY(-10vh) rotate(360deg) scale(0.5);
                opacity: 0.1;
            }
        }
        
        .cube {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            transform-style: preserve-3d;
            animation: rotate3d 15s infinite linear;
        }
        
        .sphere {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .pyramid {
            width: 0;
            height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 70px solid rgba(255,255,255,0.1);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.1));
        }
        
        .hexagon {
            width: 70px;
            height: 40px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .hexagon:before,
        .hexagon:after {
            content: "";
            position: absolute;
            width: 0;
            border-left: 35px solid transparent;
            border-right: 35px solid transparent;
        }
        
        .hexagon:before {
            bottom: 100%;
            border-bottom: 20px solid rgba(255,255,255,0.1);
        }
        
        .hexagon:after {
            top: 100%;
            border-top: 20px solid rgba(255,255,255,0.1);
        }
        
        @keyframes rotate3d {
            0% {
                transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
            }
            33% {
                transform: rotateX(120deg) rotateY(120deg) rotateZ(120deg);
            }
            66% {
                transform: rotateX(240deg) rotateY(240deg) rotateZ(240deg);
            }
            100% {
                transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg);
            }
        }
        
        /* Particle system */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            animation: particle-float 15s infinite linear;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        @keyframes particle-float {
            0% {
                transform: translateY(100vh) translateX(0px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) translateX(100px);
                opacity: 0;
            }
        }
        
        /* Ensure main content is above background */
        #mainApp {
            position: relative;
            z-index: 1;
        }
        
        /* Ensure auth screen is above background */
        #authScreen {
            position: relative;
            z-index: 1;
        }
        
        .editor-toolbar {
            border-bottom: 1px solid var(--border);
        }
        
        .tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .note-colors {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option:hover,
        .color-option.selected {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        /* Advanced Features Styles */
        .toolbar-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
        }
        
        .toolbar-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .drawing-canvas {
            border: 2px dashed var(--border);
            border-radius: 8px;
            cursor: crosshair;
        }
        
        .reminder-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            animation: pulse 2s infinite;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .kanban-column {
            min-height: 400px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
        }
        
        .kanban-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.2s;
        }
        
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day {
            background: var(--bg-primary);
            padding: 8px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .calendar-day:hover {
            background: var(--bg-secondary);
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white;
        }
        
        .calendar-event {
            background: #667eea;
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            margin-top: 2px;
            cursor: pointer;
        }
        
        .mind-map-node {
            background: var(--bg-primary);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            cursor: move;
            min-width: 100px;
            text-align: center;
        }
        
        .mind-map-connection {
            stroke: #667eea;
            stroke-width: 2;
            fill: none;
        }
        
        .habit-tracker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 8px;
        }
        
        .habit-day {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .habit-day.completed {
            background: #10b981;
            border-color: #10b981;
        }
        
        .habit-day.partial {
            background: #f59e0b;
            border-color: #f59e0b;
        }
        
        .pomodoro-timer {
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 16px 0;
        }
        
        .collaboration-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: -8px;
            position: relative;
        }
        
        .collaboration-avatar:first-child {
            margin-left: 0;
        }
        
        .version-item {
            padding: 12px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: 0 6px 6px 0;
        }
        
        .template-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .ai-suggestion {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        .weather-widget {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .quick-note-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 30;
        }
        
        .quick-note-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .stats-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .encryption-badge {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body class="light theme-bg-primary theme-text-primary transition-all duration-300">
    <!-- 3D Animated Background -->
    <div class="background-3d">
        <!-- Floating 3D Shapes -->
        <div class="floating-shapes">
            <div class="shape cube"></div>
            <div class="shape sphere"></div>
            <div class="shape pyramid"></div>
            <div class="shape hexagon"></div>
            <div class="shape cube"></div>
            <div class="shape sphere"></div>
        </div>
        
        <!-- Particle System -->
        <div class="particles" id="particles"></div>
    </div>
    <!-- Authentication Screen -->
    <div id="authScreen" class="min-h-screen auth-container flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-sticky-note text-2xl text-purple-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">NotesApp</h1>
                <p class="text-purple-100">Your thoughts, organized beautifully</p>
            </div>
            
            <div id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-red-500 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="loginEmail" class="input-3d w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-red-500 placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Enter your email">
                </div>
                <div>
                    <label class="block text-red-500 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" class="input-3d w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-red-500 placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Enter your password">
                </div>
                <button onclick="login()" class="button-3d w-full bg-white text-purple-600 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-colors">
                    Sign In
                </button>
                <div class="text-center">
                    <span class="text-red-500 font-medium">or</span>
                </div>
                <button onclick="googleLogin()" class="button-3d w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fab fa-google"></i>
                    Continue with Google
                </button>

                <button onclick="showRegister()" class="button-3d w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>
                <div class="text-center mt-4">
                    <button onclick="showRegister()" class="text-red-500 hover:text-red-300 transition-colors font-medium">
                        Don't have an account? Sign up
                    </button>
                </div>
            </div>
            
            <div id="registerForm" class="space-y-4 hidden">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Full Name</label>
                    <input type="text" id="registerName" class="input-3d w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Enter your full name" required>
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="registerEmail" class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Enter your email address" required>
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Phone Number (Optional)</label>
                    <input type="tel" id="registerPhone" class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Enter your phone number">
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 pr-12 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Create a strong password" required>
                        <button type="button" onclick="togglePasswordVisibility('registerPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/80 hover:text-white">
                            <i class="fas fa-eye" id="registerPasswordIcon"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <div class="text-xs text-white/90 mb-1">Password strength:</div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div id="passwordStrength" class="h-2 rounded-full transition-all duration-300" style="width: 0%; background: #ef4444;"></div>
                        </div>
                        <div id="passwordFeedback" class="text-xs text-white/90 mt-1">Enter a password</div>
                    </div>
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Confirm Password</label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" class="w-full px-4 py-3 pr-12 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Confirm your password" required>
                        <button type="button" onclick="togglePasswordVisibility('confirmPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/80 hover:text-white">
                            <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                        </button>
                    </div>
                    <div id="passwordMatch" class="text-xs mt-1 hidden">
                        <span class="text-red-300"><i class="fas fa-times mr-1"></i>Passwords don't match</span>
                    </div>
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Date of Birth</label>
                    <input type="date" id="registerDOB" class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Country</label>
                    <select id="registerCountry" class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                        <option value="" class="text-gray-800">Select your country</option>
                        <option value="US" class="text-gray-800">United States</option>
                        <option value="CA" class="text-gray-800">Canada</option>
                        <option value="UK" class="text-gray-800">United Kingdom</option>
                        <option value="AU" class="text-gray-800">Australia</option>
                        <option value="DE" class="text-gray-800">Germany</option>
                        <option value="FR" class="text-gray-800">France</option>
                        <option value="JP" class="text-gray-800">Japan</option>
                        <option value="IN" class="text-gray-800">India</option>
                        <option value="BR" class="text-gray-800">Brazil</option>
                        <option value="MX" class="text-gray-800">Mexico</option>
                        <option value="other" class="text-gray-800">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">How did you hear about us?</label>
                    <select id="referralSource" class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                        <option value="" class="text-gray-800">Select an option</option>
                        <option value="search" class="text-gray-800">Search Engine</option>
                        <option value="social" class="text-gray-800">Social Media</option>
                        <option value="friend" class="text-gray-800">Friend/Family</option>
                        <option value="ad" class="text-gray-800">Advertisement</option>
                        <option value="blog" class="text-gray-800">Blog/Article</option>
                        <option value="other" class="text-gray-800">Other</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="flex items-start gap-3">
                        <input type="checkbox" id="agreeTerms" class="mt-1 w-4 h-4 text-purple-600 bg-white/20 border-white/30 rounded focus:ring-purple-500 focus:ring-2" required>
                        <span class="text-sm text-white">
                            I agree to the <a href="#" class="text-white underline hover:no-underline font-medium">Terms of Service</a> and <a href="#" class="text-white underline hover:no-underline font-medium">Privacy Policy</a>
                        </span>
                    </label>
                    <label class="flex items-start gap-3">
                        <input type="checkbox" id="subscribeNewsletter" class="mt-1 w-4 h-4 text-purple-600 bg-white/20 border-white/30 rounded focus:ring-purple-500 focus:ring-2">
                        <span class="text-sm text-white">
                            Subscribe to our newsletter for updates and tips
                        </span>
                    </label>
                    <label class="flex items-start gap-3">
                        <input type="checkbox" id="enableNotifications" class="mt-1 w-4 h-4 text-purple-600 bg-white/20 border-white/30 rounded focus:ring-purple-500 focus:ring-2">
                        <span class="text-sm text-white">
                            Enable email notifications for important updates
                        </span>
                    </label>
                </div>
                <button onclick="register()" id="registerBtn" class="w-full bg-white text-purple-600 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-user-plus mr-2"></i>Create Account
                </button>
                <div class="text-center">
                    <span class="text-white font-medium">or</span>
                </div>
                <button onclick="googleRegister()" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fab fa-google"></i>
                    Sign up with Google
                </button>
                <div class="text-center mt-4">
                    <button onclick="showLogin()" class="text-white hover:text-purple-200 transition-colors font-medium">
                        Already have an account? Sign in
                    </button>
                </div>
            </div>
            

        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="theme-bg-secondary theme-border border-b px-4 py-3 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="button-3d lg:hidden p-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-sticky-note text-purple-600 text-2xl"></i>
                        <h1 class="text-xl font-bold theme-text-primary">NotesApp</h1>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <div class="relative hidden md:block">
                        <input type="text" id="searchInput" placeholder="Search notes..." class="input-3d w-64 px-4 py-2 pl-10 pr-12 rounded-lg theme-bg-tertiary theme-border border theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <i class="fas fa-search absolute left-3 top-3 theme-text-secondary"></i>
                        <button id="headerVoiceBtn" onclick="toggleVoiceSearch()" class="absolute right-3 top-2 p-1 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors" title="Voice search">
                            <i id="headerVoiceIcon" class="fas fa-microphone text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="flex items-center gap-2">
                        <button onclick="showQuickCapture()" class="p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors" title="Quick capture">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <button onclick="showNotifications()" class="p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors relative" title="Notifications">
                            <i class="fas fa-bell"></i>
                            <span id="notificationBadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                        </button>
                        <button onclick="toggleFocusMode()" class="p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors" title="Focus mode">
                            <i id="focusModeIcon" class="fas fa-eye"></i>
                        </button>
                        <button onclick="showCollaboration()" class="p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors" title="Collaboration">
                            <i class="fas fa-users"></i>
                        </button>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" class="p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors">
                        <i id="themeIcon" class="fas fa-moon"></i>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center gap-2 p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors">
                            <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                <span id="userInitial">U</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 theme-bg-secondary theme-border border rounded-lg shadow-lg py-2 z-50">
                            <div class="px-4 py-2 theme-text-secondary border-b theme-border">
                                <div class="font-medium" id="userName">User Name</div>
                                <div class="text-sm" id="userEmail">user@example.com</div>
                            </div>
                            <button onclick="showSettings()" class="w-full text-left px-4 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </button>
                            <button onclick="showKeyboardShortcuts()" class="w-full text-left px-4 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-keyboard mr-2"></i>Shortcuts
                            </button>
                            <button onclick="exportNotes()" class="w-full text-left px-4 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-download mr-2"></i>Export Notes
                            </button>
                            <button onclick="importNotes()" class="w-full text-left px-4 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-upload mr-2"></i>Import Notes
                            </button>
                            <button onclick="showBackup()" class="w-full text-left px-4 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-cloud mr-2"></i>Backup & Sync
                            </button>
                            <div class="border-t theme-border my-2"></div>
                            <button onclick="showHelp()" class="w-full text-left px-4 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-question-circle mr-2"></i>Help & Support
                            </button>
                            <button onclick="logout()" class="w-full text-left px-4 py-2 text-red-500 hover:theme-bg-tertiary transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 theme-bg-secondary theme-border border-r min-h-screen fixed lg:relative lg:translate-x-0 transform -translate-x-full transition-transform duration-300 z-30 lg:z-auto">
                <div class="p-4">
                    <button onclick="createNote()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 mb-6">
                        <i class="fas fa-plus"></i>
                        New Note
                    </button>
                    
                    <!-- Mobile Search -->
                    <div class="relative md:hidden mb-4">
                        <input type="text" id="mobileSearchInput" placeholder="Search notes..." class="input-3d w-full px-4 py-2 pl-10 rounded-lg theme-bg-tertiary theme-border border theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <i class="fas fa-search absolute left-3 top-3 theme-text-secondary"></i>
                    </div>
                    
                    <!-- Filters -->
                    <div class="space-y-2 mb-6">
                        <h3 class="font-semibold theme-text-primary mb-3">Filters</h3>
                        <button onclick="filterNotes('all')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors active">
                            <i class="fas fa-sticky-note mr-2"></i>All Notes
                        </button>
                        <button onclick="filterNotes('pinned')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-thumbtack mr-2"></i>Pinned
                        </button>
                        <button onclick="filterNotes('archived')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-archive mr-2"></i>Archived
                        </button>
                        <button onclick="filterNotes('drafts')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-edit mr-2"></i>Drafts
                        </button>
                        <button onclick="filterNotes('favorites')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-heart mr-2"></i>Favorites
                        </button>
                        <button onclick="filterNotes('shared')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-share-alt mr-2"></i>Shared
                        </button>
                        <button onclick="filterNotes('encrypted')" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-lock mr-2"></i>Encrypted
                        </button>
                    </div>
                    
                    <!-- Advanced Tools -->
                    <div class="space-y-2 mb-6">
                        <h3 class="font-semibold theme-text-primary mb-3">Tools</h3>
                        <button onclick="showKanbanBoard()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-columns mr-2"></i>Kanban Board
                        </button>
                        <button onclick="showCalendarView()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-calendar mr-2"></i>Calendar
                        </button>
                        <button onclick="showMindMap()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-project-diagram mr-2"></i>Mind Map
                        </button>
                        <button onclick="showHabitTracker()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-check-circle mr-2"></i>Habit Tracker
                        </button>
                        <button onclick="showPomodoroTimer()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-clock mr-2"></i>Pomodoro Timer
                        </button>
                        <button onclick="showAnalytics()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>Analytics
                        </button>
                        <button onclick="showTemplates()" class="filter-btn w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors">
                            <i class="fas fa-file-alt mr-2"></i>Templates
                        </button>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="space-y-2 mb-6">
                        <h3 class="font-semibold theme-text-primary mb-3">Quick Stats</h3>
                        <div class="theme-bg-tertiary rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm theme-text-secondary">Total Notes</span>
                                <span class="font-semibold theme-text-primary" id="totalNotesCount">0</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm theme-text-secondary">This Week</span>
                                <span class="font-semibold theme-text-primary" id="weekNotesCount">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm theme-text-secondary">Words Written</span>
                                <span class="font-semibold theme-text-primary" id="totalWordsCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories -->
                    <div class="space-y-2">
                        <h3 class="font-semibold theme-text-primary mb-3">Categories</h3>
                        <div id="categoriesList" class="space-y-1">
                            <!-- Categories will be populated here -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 lg:ml-0">
                <!-- Notes Grid -->
                <div id="notesView" class="p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold theme-text-primary">All Notes</h2>
                            <div class="flex items-center gap-2">
                                <select id="sortSelect" onchange="sortNotes()" class="px-3 py-2 rounded-lg theme-bg-tertiary theme-border border theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="updated">Recently Updated</option>
                                    <option value="created">Date Created</option>
                                    <option value="title">Title A-Z</option>
                                    <option value="title-desc">Title Z-A</option>
                                </select>
                                <button onclick="toggleView()" class="p-2 rounded-lg theme-bg-tertiary theme-text-primary hover:theme-text-secondary transition-colors">
                                    <i id="viewIcon" class="fas fa-th-large"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="notesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <!-- Notes will be populated here -->
                        </div>
                        
                        <div id="emptyState" class="text-center py-12 hidden">
                            <i class="fas fa-sticky-note text-6xl theme-text-secondary mb-4"></i>
                            <h3 class="text-xl font-semibold theme-text-primary mb-2">No notes yet</h3>
                            <p class="theme-text-secondary mb-4">Create your first note to get started</p>
                            <button onclick="createNote()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                Create Note
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Note Editor -->
                <div id="noteEditor" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="theme-bg-primary rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
                        <!-- Editor Header -->
                        <div class="editor-toolbar theme-bg-secondary px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                                <input type="text" id="noteTitle" placeholder="Note title..." class="input-3d text-xl font-semibold bg-transparent theme-text-primary focus:outline-none flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="encryption-badge" id="encryptionBadge" style="display: none;">
                                        <i class="fas fa-lock"></i>
                                        Encrypted
                                    </span>
                                    <span class="text-sm theme-text-secondary" id="wordCount">0 words</span>
                                    <span class="text-sm theme-text-secondary" id="lastSaved">Not saved</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleFavorite()" id="favoriteBtn" class="p-2 rounded-lg theme-text-secondary hover:theme-text-primary transition-colors" title="Add to favorites">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button onclick="togglePin()" id="pinBtn" class="p-2 rounded-lg theme-text-secondary hover:theme-text-primary transition-colors" title="Pin note">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                <button onclick="shareNote()" class="p-2 rounded-lg theme-text-secondary hover:theme-text-primary transition-colors" title="Share note">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button onclick="showVersionHistory()" class="p-2 rounded-lg theme-text-secondary hover:theme-text-primary transition-colors" title="Version history">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button onclick="toggleEncryption()" class="p-2 rounded-lg theme-text-secondary hover:theme-text-primary transition-colors" title="Encrypt note">
                                    <i class="fas fa-lock"></i>
                                </button>
                                <div class="border-l theme-border h-6 mx-2"></div>
                                <button onclick="saveNote()" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                    Save
                                </button>
                                <button onclick="closeEditor()" class="p-2 rounded-lg theme-text-secondary hover:theme-text-primary transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Editor Content -->
                        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                            <!-- Rich Text Toolbar -->
                            <div class="mb-4 p-3 theme-bg-tertiary rounded-lg border theme-border">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <div class="flex items-center gap-1">
                                        <button onclick="formatText('bold')" class="toolbar-btn" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button onclick="formatText('italic')" class="toolbar-btn" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button onclick="formatText('underline')" class="toolbar-btn" title="Underline">
                                            <i class="fas fa-underline"></i>
                                        </button>
                                        <button onclick="formatText('strikethrough')" class="toolbar-btn" title="Strikethrough">
                                            <i class="fas fa-strikethrough"></i>
                                        </button>
                                    </div>
                                    <div class="border-l theme-border h-6"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="formatText('h1')" class="toolbar-btn" title="Heading 1">H1</button>
                                        <button onclick="formatText('h2')" class="toolbar-btn" title="Heading 2">H2</button>
                                        <button onclick="formatText('h3')" class="toolbar-btn" title="Heading 3">H3</button>
                                    </div>
                                    <div class="border-l theme-border h-6"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="formatText('ul')" class="toolbar-btn" title="Bullet list">
                                            <i class="fas fa-list-ul"></i>
                                        </button>
                                        <button onclick="formatText('ol')" class="toolbar-btn" title="Numbered list">
                                            <i class="fas fa-list-ol"></i>
                                        </button>
                                        <button onclick="formatText('quote')" class="toolbar-btn" title="Quote">
                                            <i class="fas fa-quote-left"></i>
                                        </button>
                                        <button onclick="formatText('code')" class="toolbar-btn" title="Code">
                                            <i class="fas fa-code"></i>
                                        </button>
                                    </div>
                                    <div class="border-l theme-border h-6"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="insertTable()" class="toolbar-btn" title="Insert table">
                                            <i class="fas fa-table"></i>
                                        </button>
                                        <button onclick="insertLink()" class="toolbar-btn" title="Insert link">
                                            <i class="fas fa-link"></i>
                                        </button>
                                        <button onclick="insertImage()" class="toolbar-btn" title="Insert image">
                                            <i class="fas fa-image"></i>
                                        </button>
                                        <button onclick="showDrawingTool()" class="toolbar-btn" title="Drawing tool">
                                            <i class="fas fa-paint-brush"></i>
                                        </button>
                                    </div>
                                    <div class="border-l theme-border h-6"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="insertCheckbox()" class="toolbar-btn" title="Checkbox">
                                            <i class="fas fa-check-square"></i>
                                        </button>
                                        <button onclick="insertDate()" class="toolbar-btn" title="Insert date">
                                            <i class="fas fa-calendar-alt"></i>
                                        </button>
                                        <button onclick="setReminder()" class="toolbar-btn" title="Set reminder">
                                            <i class="fas fa-bell"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4 relative">
                                <textarea id="noteContent" placeholder="Start writing your note..." class="textarea-3d w-full h-64 p-4 pr-16 theme-bg-tertiary theme-border border rounded-lg theme-text-primary resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                                <div class="absolute bottom-4 right-4 flex gap-2">
                                    <button id="voiceBtn" onclick="toggleVoiceRecording()" class="p-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors" title="Voice to text">
                                        <i id="voiceIcon" class="fas fa-microphone"></i>
                                    </button>
                                    <button onclick="showAIAssistant()" class="p-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors" title="AI Assistant">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                </div>
                                <div id="voiceStatus" class="hidden absolute top-2 left-2 bg-red-500 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                                    <span>Listening...</span>
                                </div>
                            </div>
                            
                            <!-- Drawing Canvas (Hidden by default) -->
                            <div id="drawingArea" class="hidden mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-medium theme-text-primary">Drawing Tool</h4>
                                    <div class="flex items-center gap-2">
                                        <input type="color" id="drawColor" value="#667eea" class="w-8 h-8 rounded border-0">
                                        <input type="range" id="drawSize" min="1" max="20" value="3" class="w-20">
                                        <button onclick="clearCanvas()" class="px-3 py-1 bg-red-500 text-white rounded text-sm">Clear</button>
                                        <button onclick="saveDrawing()" class="px-3 py-1 bg-green-500 text-white rounded text-sm">Save</button>
                                    </div>
                                </div>
                                <canvas id="drawingCanvas" width="600" height="300" class="drawing-canvas w-full"></canvas>
                            </div>
                            
                            <!-- Note Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Tags -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Tags</label>
                                    <div class="flex flex-wrap gap-2 mb-2" id="noteTags">
                                        <!-- Tags will appear here -->
                                    </div>
                                    <input type="text" id="tagInput" placeholder="Add tags (press Enter)" class="input-3d w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                
                                <!-- Category -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Category</label>
                                    <select id="noteCategory" class="select-3d w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="">Select category</option>
                                        <option value="personal">Personal</option>
                                        <option value="work">Work</option>
                                        <option value="ideas">Ideas</option>
                                        <option value="todo">To-Do</option>
                                        <option value="meeting">Meeting Notes</option>
                                        <option value="research">Research</option>
                                        <option value="project">Project</option>
                                        <option value="journal">Journal</option>
                                    </select>
                                </div>
                                
                                <!-- Priority -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Priority</label>
                                    <select id="notePriority" class="select-3d w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                                
                                <!-- Color -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Color</label>
                                    <div class="note-colors">
                                        <div class="color-option" style="background: #ffffff;" data-color="#ffffff"></div>
                                        <div class="color-option" style="background: #fef3c7;" data-color="#fef3c7"></div>
                                        <div class="color-option" style="background: #fecaca;" data-color="#fecaca"></div>
                                        <div class="color-option" style="background: #c7d2fe;" data-color="#c7d2fe"></div>
                                        <div class="color-option" style="background: #bbf7d0;" data-color="#bbf7d0"></div>
                                        <div class="color-option" style="background: #fed7d7;" data-color="#fed7d7"></div>
                                        <div class="color-option" style="background: #e0e7ff;" data-color="#e0e7ff"></div>
                                        <div class="color-option" style="background: #fef7cd;" data-color="#fef7cd"></div>
                                        <div class="color-option" style="background: #d1fae5;" data-color="#d1fae5"></div>
                                        <div class="color-option" style="background: #fce7f3;" data-color="#fce7f3"></div>
                                        <div class="color-option" style="background: #f3e8ff;" data-color="#f3e8ff"></div>
                                        <div class="color-option" style="background: #ecfdf5;" data-color="#ecfdf5"></div>
                                    </div>
                                </div>
                                
                                <!-- Status -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Status</label>
                                    <select id="noteStatus" class="select-3d w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="published">Published</option>
                                        <option value="draft">Draft</option>
                                        <option value="archived">Archived</option>
                                        <option value="review">Under Review</option>
                                        <option value="template">Template</option>
                                    </select>
                                </div>
                                
                                <!-- Due Date -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Due Date</label>
                                    <input type="datetime-local" id="noteDueDate" class="input-3d w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                
                                <!-- Location -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Location</label>
                                    <input type="text" id="noteLocation" placeholder="Add location..." class="w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                
                                <!-- Collaborators -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Collaborators</label>
                                    <div class="flex items-center gap-2 mb-2" id="collaboratorsList">
                                        <!-- Collaborators will appear here -->
                                    </div>
                                    <input type="email" id="collaboratorInput" placeholder="Add collaborator email..." class="w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                
                                <!-- Progress -->
                                <div>
                                    <label class="block font-medium theme-text-primary mb-2">Progress</label>
                                    <div class="space-y-2">
                                        <input type="range" id="noteProgress" min="0" max="100" value="0" class="w-full">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                        </div>
                                        <div class="text-sm theme-text-secondary text-center">
                                            <span id="progressText">0%</span> Complete
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Options -->
                            <div class="mt-6 p-4 theme-bg-tertiary rounded-lg">
                                <h4 class="font-medium theme-text-primary mb-3">Advanced Options</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="enableReminders" class="rounded">
                                        <span class="theme-text-primary">Enable reminders</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="enableCollaboration" class="rounded">
                                        <span class="theme-text-primary">Allow collaboration</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="enableVersioning" class="rounded">
                                        <span class="theme-text-primary">Track versions</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="enableEncryption" class="rounded">
                                        <span class="theme-text-primary">Encrypt note</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden" onclick="closeSidebar()"></div>

    <!-- Quick Note FAB -->
    <div class="quick-note-fab" onclick="showQuickNote()" title="Quick Note">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Advanced Feature Modals -->
    
    <!-- Quick Capture Modal -->
    <div id="quickCaptureModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="theme-bg-primary rounded-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Quick Capture</h3>
                    <button onclick="closeQuickCapture()" class="theme-text-secondary hover:theme-text-primary">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <textarea id="quickCaptureText" placeholder="Quickly jot down your thoughts..." class="w-full h-32 p-3 theme-bg-tertiary theme-border border rounded-lg theme-text-primary resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="closeQuickCapture()" class="px-4 py-2 theme-text-secondary hover:theme-text-primary">Cancel</button>
                    <button onclick="saveQuickCapture()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="hidden fixed top-16 right-4 w-80 theme-bg-secondary theme-border border rounded-lg shadow-lg z-50">
        <div class="p-4 border-b theme-border">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold theme-text-primary">Notifications</h3>
                <button onclick="closeNotifications()" class="theme-text-secondary hover:theme-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="max-h-96 overflow-y-auto">
            <div class="p-4 border-b theme-border">
                <div class="flex items-start gap-3">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                    <div>
                        <p class="theme-text-primary text-sm">Reminder: Review project proposal</p>
                        <p class="theme-text-secondary text-xs mt-1">Due in 2 hours</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-b theme-border">
                <div class="flex items-start gap-3">
                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                    <div>
                        <p class="theme-text-primary text-sm">Sarah shared a note with you</p>
                        <p class="theme-text-secondary text-xs mt-1">5 minutes ago</p>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-start gap-3">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                    <div>
                        <p class="theme-text-primary text-sm">Weekly backup completed</p>
                        <p class="theme-text-secondary text-xs mt-1">1 hour ago</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Panel -->
    <div id="aiAssistantPanel" class="hidden fixed bottom-20 right-4 w-80 theme-bg-secondary theme-border border rounded-lg shadow-lg z-50">
        <div class="p-4 border-b theme-border">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold theme-text-primary flex items-center gap-2">
                    <i class="fas fa-robot text-green-600"></i>
                    AI Assistant
                </h3>
                <button onclick="closeAIAssistant()" class="theme-text-secondary hover:theme-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-4 space-y-3">
            <div class="ai-suggestion">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-lightbulb"></i>
                    <span class="font-medium">Suggestion</span>
                </div>
                <p class="text-sm">Consider adding more details about the implementation timeline in your project note.</p>
                <button onclick="applyAISuggestion(1)" class="mt-2 text-xs bg-white/20 px-2 py-1 rounded">Apply</button>
            </div>
            <div class="ai-suggestion">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-spell-check"></i>
                    <span class="font-medium">Grammar Check</span>
                </div>
                <p class="text-sm">Found 2 potential grammar improvements in your current note.</p>
                <button onclick="applyAISuggestion(2)" class="mt-2 text-xs bg-white/20 px-2 py-1 rounded">Fix</button>
            </div>
            <div class="ai-suggestion">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-tags"></i>
                    <span class="font-medium">Auto-Tag</span>
                </div>
                <p class="text-sm">Suggested tags: #productivity, #planning, #goals</p>
                <button onclick="applyAISuggestion(3)" class="mt-2 text-xs bg-white/20 px-2 py-1 rounded">Add Tags</button>
            </div>
        </div>
    </div>

    <!-- Collaboration Panel -->
    <div id="collaborationPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="theme-bg-primary rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <!-- Collaboration Header -->
            <div class="theme-bg-secondary px-6 py-4 flex items-center justify-between border-b theme-border">
                <div class="flex items-center gap-3">
                    <i class="fas fa-users text-purple-600 text-xl"></i>
                    <h3 class="text-xl font-semibold theme-text-primary">Collaboration Hub</h3>
                </div>
                <button onclick="closeCollaboration()" class="theme-text-secondary hover:theme-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Collaboration Content -->
            <div class="flex h-full" style="max-height: calc(90vh - 80px);">
                <!-- Sidebar -->
                <div class="w-80 theme-bg-tertiary border-r theme-border p-4 overflow-y-auto">
                    <!-- Active Collaborators -->
                    <div class="mb-6">
                        <h4 class="font-semibold theme-text-primary mb-3 flex items-center gap-2">
                            <i class="fas fa-circle text-green-500 text-xs"></i>
                            Online Now (3)
                        </h4>
                        <div class="space-y-2" id="activeCollaborators">
                            <div class="flex items-center gap-3 p-2 rounded-lg theme-bg-secondary">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        SK
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium theme-text-primary text-sm">Sarah Kim</div>
                                    <div class="text-xs theme-text-secondary">Editing "Project Plan"</div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="startVideoCall('sarah')" class="p-1 rounded hover:theme-bg-tertiary" title="Video call">
                                        <i class="fas fa-video text-xs theme-text-secondary"></i>
                                    </button>
                                    <button onclick="sendMessage('sarah')" class="p-1 rounded hover:theme-bg-tertiary" title="Message">
                                        <i class="fas fa-comment text-xs theme-text-secondary"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3 p-2 rounded-lg theme-bg-secondary">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        MJ
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium theme-text-primary text-sm">Mike Johnson</div>
                                    <div class="text-xs theme-text-secondary">Viewing "Meeting Notes"</div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="startVideoCall('mike')" class="p-1 rounded hover:theme-bg-tertiary" title="Video call">
                                        <i class="fas fa-video text-xs theme-text-secondary"></i>
                                    </button>
                                    <button onclick="sendMessage('mike')" class="p-1 rounded hover:theme-bg-tertiary" title="Message">
                                        <i class="fas fa-comment text-xs theme-text-secondary"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3 p-2 rounded-lg theme-bg-secondary">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        AL
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium theme-text-primary text-sm">Anna Lee</div>
                                    <div class="text-xs theme-text-secondary">Adding comments</div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="startVideoCall('anna')" class="p-1 rounded hover:theme-bg-tertiary" title="Video call">
                                        <i class="fas fa-video text-xs theme-text-secondary"></i>
                                    </button>
                                    <button onclick="sendMessage('anna')" class="p-1 rounded hover:theme-bg-tertiary" title="Message">
                                        <i class="fas fa-comment text-xs theme-text-secondary"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team Members -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold theme-text-primary">Team Members (8)</h4>
                            <button onclick="inviteMembers()" class="text-purple-600 hover:text-purple-700">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </div>
                        <div class="space-y-2" id="teamMembers">
                            <div class="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        JD
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 border-2 border-white rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium theme-text-primary text-sm">John Doe</div>
                                    <div class="text-xs theme-text-secondary">Last seen 2h ago</div>
                                </div>
                                <div class="text-xs theme-text-secondary">Admin</div>
                            </div>
                            
                            <div class="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        ER
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 border-2 border-white rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium theme-text-primary text-sm">Emma Rodriguez</div>
                                    <div class="text-xs theme-text-secondary">Last seen 1d ago</div>
                                </div>
                                <div class="text-xs theme-text-secondary">Editor</div>
                            </div>
                            
                            <div class="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        DW
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 border-2 border-white rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium theme-text-primary text-sm">David Wilson</div>
                                    <div class="text-xs theme-text-secondary">Last seen 3d ago</div>
                                </div>
                                <div class="text-xs theme-text-secondary">Viewer</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div>
                        <h4 class="font-semibold theme-text-primary mb-3">Recent Activity</h4>
                        <div class="space-y-3" id="recentActivity">
                            <div class="flex items-start gap-2">
                                <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mt-0.5">
                                    <i class="fas fa-edit text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm theme-text-primary">Sarah edited "Project Timeline"</p>
                                    <p class="text-xs theme-text-secondary">2 minutes ago</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-2">
                                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mt-0.5">
                                    <i class="fas fa-comment text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm theme-text-primary">Mike added a comment</p>
                                    <p class="text-xs theme-text-secondary">5 minutes ago</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-2">
                                <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center mt-0.5">
                                    <i class="fas fa-share text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm theme-text-primary">Anna shared "Design Mockups"</p>
                                    <p class="text-xs theme-text-secondary">10 minutes ago</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-2">
                                <div class="w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center mt-0.5">
                                    <i class="fas fa-user-plus text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm theme-text-primary">John invited Emma to workspace</p>
                                    <p class="text-xs theme-text-secondary">1 hour ago</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content Area -->
                <div class="flex-1 flex flex-col">
                    <!-- Tab Navigation -->
                    <div class="flex border-b theme-border">
                        <button onclick="switchCollabTab('shared')" class="collab-tab px-6 py-3 font-medium theme-text-primary border-b-2 border-purple-600 bg-purple-50 dark:bg-purple-900/20">
                            <i class="fas fa-share-alt mr-2"></i>Shared Notes
                        </button>
                        <button onclick="switchCollabTab('comments')" class="collab-tab px-6 py-3 font-medium theme-text-secondary hover:theme-text-primary border-b-2 border-transparent">
                            <i class="fas fa-comments mr-2"></i>Comments
                        </button>
                        <button onclick="switchCollabTab('permissions')" class="collab-tab px-6 py-3 font-medium theme-text-secondary hover:theme-text-primary border-b-2 border-transparent">
                            <i class="fas fa-shield-alt mr-2"></i>Permissions
                        </button>
                        <button onclick="switchCollabTab('chat')" class="collab-tab px-6 py-3 font-medium theme-text-secondary hover:theme-text-primary border-b-2 border-transparent relative">
                            <i class="fas fa-comment-dots mr-2"></i>Team Chat
                            <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="flex-1 overflow-y-auto">
                        <!-- Shared Notes Tab -->
                        <div id="sharedNotesTab" class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold theme-text-primary">Shared Notes</h3>
                                <button onclick="shareNewNote()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Share Note
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sharedNotesList">
                                <!-- Shared notes will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Comments Tab -->
                        <div id="commentsTab" class="hidden p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold theme-text-primary">Comments & Feedback</h3>
                                <div class="flex items-center gap-2">
                                    <select class="px-3 py-2 rounded-lg theme-bg-tertiary theme-border border theme-text-primary">
                                        <option>All Notes</option>
                                        <option>My Notes</option>
                                        <option>Shared with Me</option>
                                    </select>
                                    <button onclick="markAllCommentsRead()" class="text-purple-600 hover:text-purple-700 text-sm">
                                        Mark all read
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-4" id="commentsList">
                                <!-- Comments will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Permissions Tab -->
                        <div id="permissionsTab" class="hidden p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold theme-text-primary">Access & Permissions</h3>
                                <button onclick="createWorkspace()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Create Workspace
                                </button>
                            </div>
                            
                            <div class="space-y-6" id="permissionsList">
                                <!-- Permissions will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Team Chat Tab -->
                        <div id="chatTab" class="hidden flex flex-col h-full">
                            <div class="p-4 border-b theme-border">
                                <h3 class="text-lg font-semibold theme-text-primary">Team Chat</h3>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatMessages">
                                <!-- Chat messages will be populated here -->
                            </div>
                            
                            <div class="p-4 border-t theme-border">
                                <div class="flex items-center gap-2">
                                    <input type="text" id="chatInput" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-lg theme-bg-tertiary theme-border border theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <button onclick="sendChatMessage()" class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition-colors">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    <button onclick="attachFile()" class="theme-text-secondary hover:theme-text-primary p-2 rounded-lg hover:theme-bg-tertiary">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <button onclick="startVoiceMessage()" class="theme-text-secondary hover:theme-text-primary p-2 rounded-lg hover:theme-bg-tertiary">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Members Modal -->
    <div id="inviteMembersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="theme-bg-primary rounded-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Invite Team Members</h3>
                    <button onclick="closeInviteModal()" class="theme-text-secondary hover:theme-text-primary">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-2">Email addresses</label>
                        <textarea id="inviteEmails" placeholder="Enter email addresses (one per line)" class="w-full h-24 px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-2">Permission level</label>
                        <select id="invitePermission" class="w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="viewer">Viewer - Can view notes</option>
                            <option value="editor">Editor - Can edit notes</option>
                            <option value="admin">Admin - Full access</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-2">Personal message (optional)</label>
                        <textarea id="inviteMessage" placeholder="Add a personal message to your invitation..." class="w-full h-20 px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="closeInviteModal()" class="px-4 py-2 theme-text-secondary hover:theme-text-primary">Cancel</button>
                    <button onclick="sendInvitations()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Send Invitations</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Call Modal -->
    <div id="videoCallModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl h-full max-h-[80vh] bg-gray-900 rounded-lg overflow-hidden">
            <div class="flex items-center justify-between p-4 bg-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-sm font-semibold" id="calleeAvatar">
                        SK
                    </div>
                    <div>
                        <div class="text-white font-medium" id="calleeName">Sarah Kim</div>
                        <div class="text-gray-400 text-sm" id="callStatus">Connecting...</div>
                    </div>
                </div>
                <button onclick="endCall()" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
            
            <div class="relative h-full bg-gray-800 flex items-center justify-center">
                <div class="text-center text-white">
                    <div class="w-32 h-32 bg-purple-600 rounded-full flex items-center justify-center text-white text-4xl font-semibold mx-auto mb-4" id="calleeAvatarLarge">
                        SK
                    </div>
                    <div class="text-xl font-medium mb-2" id="calleeNameLarge">Sarah Kim</div>
                    <div class="text-gray-400" id="callStatusLarge">Ringing...</div>
                </div>
                
                <!-- Call Controls -->
                <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex items-center gap-4">
                    <button onclick="toggleMute()" class="bg-gray-700 text-white p-3 rounded-full hover:bg-gray-600" id="muteBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button onclick="toggleVideo()" class="bg-gray-700 text-white p-3 rounded-full hover:bg-gray-600" id="videoBtn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button onclick="shareScreen()" class="bg-gray-700 text-white p-3 rounded-full hover:bg-gray-600">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button onclick="endCall()" class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let notes = [];
        let currentNote = null;
        let currentFilter = 'all';
        let currentSort = 'updated';
        let isDarkMode = false;
        let isGridView = true;
        let recognition = null;
        let isRecording = false;
        let isFocusMode = false;
        let drawingContext = null;
        let isDrawing = false;
        let pomodoroTimer = null;
        let pomodoroTimeLeft = 25 * 60; // 25 minutes
        let pomodoroIsRunning = false;
        let habits = [];
        let reminders = [];
        let collaborators = [];
        let versionHistory = [];
        let templates = [];
        let analytics = {
            totalNotes: 0,
            wordsWritten: 0,
            notesThisWeek: 0,
            averageWordsPerNote: 0,
            mostUsedTags: [],
            productivityScore: 0
        };
        
        // Collaboration state
        let sharedNotes = [];
        let teamMembers = [];
        let chatMessages = [];
        let comments = [];
        let workspaces = [];
        let currentCollabTab = 'shared';
        let isCallActive = false;
        let isMuted = false;
        let isVideoOn = true;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setupEventListeners();
            initializeSpeechRecognition();
            initializeBackground();
            initializeCollaborationData();
            
            // Check if user is logged in
            if (currentUser) {
                showMainApp();
            }
        });

        // Initialize 3D background
        function initializeBackground() {
            createParticles();
            initializeShapes();
            
            // Add some dynamic background effects
            setInterval(() => {
                addRandomParticle();
            }, 2000);
        }
        
        function initializeShapes() {
            const shapes = document.querySelectorAll('.shape');
            shapes.forEach((shape, index) => {
                // Set random initial positions
                shape.style.top = Math.random() * 100 + 'vh';
                shape.style.transform = `translateY(0) rotate(${Math.random() * 360}deg) scale(${0.5 + Math.random() * 0.5})`;
            });
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            
            // Create initial particles
            for (let i = 0; i < 50; i++) {
                createParticle(particlesContainer);
            }
        }

        function createParticle(container) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Random starting position
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
            
            // Random size
            const size = Math.random() * 4 + 2;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            
            // Random opacity
            particle.style.opacity = Math.random() * 0.5 + 0.1;
            
            container.appendChild(particle);
            
            // Remove particle after animation
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 25000);
        }

        function addRandomParticle() {
            const particlesContainer = document.getElementById('particles');
            if (particlesContainer) {
                createParticle(particlesContainer);
            }
        }

        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('mobileSearchInput').addEventListener('input', handleSearch);
            
            // Tag input
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTag();
                }
            });
            
            // Color selection
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectColor(this.dataset.color);
                });
            });
            
            // Auto-save and word count
            document.getElementById('noteContent').addEventListener('input', function() {
                updateWordCount();
                debounce(autoSave, 2000)();
            });
            document.getElementById('noteTitle').addEventListener('input', debounce(autoSave, 2000));
            
            // Progress slider
            document.getElementById('noteProgress').addEventListener('input', updateProgress);
            
            // Collaborator input
            document.getElementById('collaboratorInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCollaborator();
                }
            });
            
            // Password validation
            document.getElementById('registerPassword').addEventListener('input', checkPasswordStrength);
            document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            createNote();
                            break;
                        case 's':
                            e.preventDefault();
                            if (currentNote) saveNote();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                        case 'k':
                            e.preventDefault();
                            showQuickCapture();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            if (currentNote) closeEditor();
                            break;
                    }
                }
            });
            
            // Close menus when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#userMenu') && !e.target.closest('button[onclick="toggleUserMenu()"]')) {
                    document.getElementById('userMenu').classList.add('hidden');
                }
                
                if (!e.target.closest('#notificationsPanel') && !e.target.closest('button[onclick="showNotifications()"]')) {
                    document.getElementById('notificationsPanel').classList.add('hidden');
                }
                
                if (!e.target.closest('#aiAssistantPanel') && !e.target.closest('button[onclick="showAIAssistant()"]')) {
                    document.getElementById('aiAssistantPanel').classList.add('hidden');
                }
                
                if (!e.target.closest('#collaborationPanel') && !e.target.closest('button[onclick="showCollaboration()"]')) {
                    document.getElementById('collaborationPanel').classList.add('hidden');
                }
            });
            
            // Chat input enter key support
            document.addEventListener('keydown', function(e) {
                if (e.target.id === 'chatInput' && e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Auto-hide notifications after 5 seconds
            setInterval(() => {
                document.querySelectorAll('.notification').forEach(notification => {
                    if (notification.dataset.timestamp && Date.now() - parseInt(notification.dataset.timestamp) > 5000) {
                        notification.remove();
                    }
                });
            }, 1000);

            // Handle window resize for sidebar
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) { // lg breakpoint
                    // On desktop, ensure sidebar is visible and body scroll is restored
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            });
        }
        
        // Enhanced functions
        function addCollaborator() {
            const input = document.getElementById('collaboratorInput');
            const email = input.value.trim();
            
            if (email && currentNote && !currentNote.collaborators.includes(email)) {
                currentNote.collaborators.push(email);
                input.value = '';
                renderCollaborators();
                showNotification(`Added ${email} as collaborator`, 'success');
            }
        }
        
        function renderCollaborators() {
            const container = document.getElementById('collaboratorsList');
            container.innerHTML = '';
            
            if (currentNote && currentNote.collaborators) {
                currentNote.collaborators.forEach(email => {
                    const collaboratorElement = document.createElement('div');
                    collaboratorElement.className = 'collaboration-avatar bg-purple-600 text-white flex items-center justify-center text-xs font-semibold';
                    collaboratorElement.textContent = email.charAt(0).toUpperCase();
                    collaboratorElement.title = email;
                    container.appendChild(collaboratorElement);
                });
            }
        }

        // Authentication functions
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            // Simulate login
            currentUser = {
                id: 'user_' + Date.now(),
                name: email.split('@')[0],
                email: email,
                loginMethod: 'email'
            };
            
            saveToStorage();
            showMainApp();
        }

        function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const dob = document.getElementById('registerDOB').value;
            const country = document.getElementById('registerCountry').value;
            const referralSource = document.getElementById('referralSource').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const subscribeNewsletter = document.getElementById('subscribeNewsletter').checked;
            const enableNotifications = document.getElementById('enableNotifications').checked;
            
            // Validation
            if (!name || !email || !password || !confirmPassword) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (!agreeTerms) {
                showNotification('Please agree to the Terms of Service and Privacy Policy', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (!isValidPassword(password)) {
                showNotification('Password does not meet requirements', 'error');
                return;
            }
            
            // Simulate registration
            currentUser = {
                id: 'user_' + Date.now(),
                name: name,
                email: email,
                phone: phone,
                dateOfBirth: dob,
                country: country,
                referralSource: referralSource,
                preferences: {
                    newsletter: subscribeNewsletter,
                    notifications: enableNotifications
                },
                loginMethod: 'email',
                registeredAt: new Date().toISOString()
            };
            
            showNotification('Account created successfully! Welcome to NotesApp!', 'success');
            saveToStorage();
            setTimeout(() => showMainApp(), 1500);
        }

        function googleRegister() {
            showGoogleAccountSelector();
        }

        function googleLogin() {
            showGoogleAccountSelector();
        }

        function showGoogleAccountSelector() {
            // Create Google account selector popup
            const popup = document.createElement('div');
            popup.id = 'googlePopup';
            popup.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            popup.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-sm mx-auto shadow-2xl fade-in">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%234285F4' d='M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z'/%3E%3Cpath fill='%2334A853' d='M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z'/%3E%3Cpath fill='%23FBBC05' d='M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z'/%3E%3Cpath fill='%23EA4335' d='M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z'/%3E%3C/svg%3E" alt="Google" class="w-6 h-6">
                                <h3 class="text-lg font-semibold text-gray-800">Choose an account</h3>
                            </div>
                            <button onclick="closeGooglePopup()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="selectGoogleAccount('alexandra.rodriguez.work@gmail.com', 'Alexandra Rodriguez')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                                <div class="w-10 h-10 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                    AR
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-800 truncate">Alexandra Rodriguez</div>
                                    <div class="text-sm text-gray-500 truncate">alexandra.rodriguez.work@gmail.com</div>
                                </div>
                                <div class="text-xs text-gray-400">Default</div>
                            </button>
                            
                            <button onclick="selectGoogleAccount('david.kim.personal@gmail.com', 'David Kim')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                    DK
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-800 truncate">David Kim</div>
                                    <div class="text-sm text-gray-500 truncate">david.kim.personal@gmail.com</div>
                                </div>
                            </button>
                            
                            <button onclick="selectGoogleAccount('maria.santos.dev@gmail.com', 'Maria Santos')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                    MS
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-800 truncate">Maria Santos</div>
                                    <div class="text-sm text-gray-500 truncate">maria.santos.dev@gmail.com</div>
                                </div>
                            </button>
                            
                            <button onclick="selectGoogleAccount('james.thompson.2024@gmail.com', 'James Thompson')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                                <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                    JT
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-800 truncate">James Thompson</div>
                                    <div class="text-sm text-gray-500 truncate">james.thompson.2024@gmail.com</div>
                                </div>
                            </button>
                            
                            <button onclick="selectGoogleAccount('priya.patel.studio@gmail.com', 'Priya Patel')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                                <div class="w-10 h-10 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                    PP
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-800 truncate">Priya Patel</div>
                                    <div class="text-sm text-gray-500 truncate">priya.patel.studio@gmail.com</div>
                                </div>
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <button onclick="addGoogleAccount()" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                                <div class="w-10 h-10 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-plus text-gray-400"></i>
                                </div>
                                <div class="text-gray-600 font-medium">Use another account</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 bg-gray-50 rounded-b-2xl">
                        <div class="flex items-center justify-center gap-4 text-xs text-gray-500">
                            <a href="#" class="hover:text-gray-700">Privacy Policy</a>
                            <span></span>
                            <a href="#" class="hover:text-gray-700">Terms of Service</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        function selectGoogleAccount(email, name) {
            // Simulate Google OAuth success
            currentUser = {
                id: 'user_google_' + Date.now(),
                name: name,
                email: email,
                loginMethod: 'google'
            };
            
            closeGooglePopup();
            saveToStorage();
            showMainApp();
        }

        function addGoogleAccount() {
            closeGooglePopup();
            // Show a simple input for demo purposes
            const email = prompt('Enter your Google email:');
            if (email) {
                const name = email.split('@')[0].replace('.', ' ').replace(/\b\w/g, l => l.toUpperCase());
                selectGoogleAccount(email, name);
            }
        }

        function closeGooglePopup() {
            const popup = document.getElementById('googlePopup');
            if (popup) {
                popup.remove();
            }
        }



        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        // Password visibility toggle
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + 'Icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Password strength checker
        function checkPasswordStrength() {
            const password = document.getElementById('registerPassword').value;
            const strengthBar = document.getElementById('passwordStrength');
            const feedback = document.getElementById('passwordFeedback');
            
            let strength = 0;
            let feedbackText = '';
            let color = '#ef4444';
            
            if (password.length >= 8) strength += 20;
            if (password.match(/[a-z]/)) strength += 20;
            if (password.match(/[A-Z]/)) strength += 20;
            if (password.match(/[0-9]/)) strength += 20;
            if (password.match(/[^a-zA-Z0-9]/)) strength += 20;
            
            if (strength === 0) {
                feedbackText = 'Enter a password';
                color = '#ef4444';
            } else if (strength <= 40) {
                feedbackText = 'Weak password';
                color = '#ef4444';
            } else if (strength <= 60) {
                feedbackText = 'Fair password';
                color = '#f59e0b';
            } else if (strength <= 80) {
                feedbackText = 'Good password';
                color = '#3b82f6';
            } else {
                feedbackText = 'Strong password';
                color = '#10b981';
            }
            
            strengthBar.style.width = strength + '%';
            strengthBar.style.background = color;
            feedback.textContent = feedbackText;
            feedback.style.color = color;
        }

        // Password match checker
        function checkPasswordMatch() {
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchIndicator = document.getElementById('passwordMatch');
            
            if (confirmPassword && password !== confirmPassword) {
                matchIndicator.classList.remove('hidden');
                matchIndicator.innerHTML = '<span class="text-red-300"><i class="fas fa-times mr-1"></i>Passwords don\'t match</span>';
            } else if (confirmPassword && password === confirmPassword) {
                matchIndicator.classList.remove('hidden');
                matchIndicator.innerHTML = '<span class="text-green-300"><i class="fas fa-check mr-1"></i>Passwords match</span>';
            } else {
                matchIndicator.classList.add('hidden');
            }
        }

        // Password validation
        function isValidPassword(password) {
            return password.length >= 8 && 
                   password.match(/[a-z]/) && 
                   password.match(/[A-Z]/) && 
                   password.match(/[0-9]/);
        }

        // Speech Recognition Setup
        let searchRecognition = null;
        let isSearchRecording = false;
        
        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Stop the stream immediately as we only needed permission
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('Microphone permission error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showMicrophonePermissionDialog();
                } else if (error.name === 'NotFoundError') {
                    showNotification('No microphone found. Please connect a microphone and try again.', 'error');
                } else {
                    showNotification('Unable to access microphone. Please check your browser settings.', 'error');
                }
                return false;
            }
        }

        function showMicrophonePermissionDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'micPermissionDialog';
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-md mx-auto shadow-2xl fade-in">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-microphone-slash text-2xl text-red-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Microphone Access Required</h3>
                            <p class="text-gray-600">To use voice features, please allow microphone access in your browser.</p>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">How to enable microphone access:</h4>
                                <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                                    <li>Look for the microphone icon in your browser's address bar</li>
                                    <li>Click on it and select "Allow"</li>
                                    <li>If you don't see it, check your browser settings</li>
                                    <li>Refresh the page after granting permission</li>
                                </ol>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                                    <div>
                                        <h4 class="font-semibold text-yellow-800">Privacy Note</h4>
                                        <p class="text-sm text-yellow-700">Your voice data is processed locally and never stored or transmitted to our servers.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeMicPermissionDialog()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                            <button onclick="retryMicrophoneAccess()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }

        function closeMicPermissionDialog() {
            const dialog = document.getElementById('micPermissionDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        async function retryMicrophoneAccess() {
            closeMicPermissionDialog();
            const hasPermission = await requestMicrophonePermission();
            if (hasPermission) {
                showNotification('Microphone access granted! You can now use voice features.', 'success');
                initializeSpeechRecognition();
            }
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                // Note editor recognition
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isRecording = true;
                    updateVoiceUI();
                    showNotification(' Listening... Speak now!', 'info');
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const noteContent = document.getElementById('noteContent');
                    if (finalTranscript) {
                        // Add final transcript to the textarea
                        const currentText = noteContent.value;
                        const cursorPosition = noteContent.selectionStart;
                        const newText = currentText.slice(0, cursorPosition) + finalTranscript + currentText.slice(cursorPosition);
                        noteContent.value = newText;
                        
                        // Move cursor to end of inserted text
                        const newCursorPosition = cursorPosition + finalTranscript.length;
                        noteContent.setSelectionRange(newCursorPosition, newCursorPosition);
                        
                        // Trigger auto-save
                        autoSave();
                        
                        // Show what was transcribed
                        showNotification(`Added: "${finalTranscript.trim()}"`, 'success');
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = 'Voice recognition error occurred.';
                    
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'No speech detected. Please speak clearly and try again.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'Microphone not accessible. Please check your microphone connection.';
                            break;
                        case 'not-allowed':
                            showMicrophonePermissionDialog();
                            return;
                        case 'network':
                            errorMessage = 'Network error occurred. Please check your internet connection.';
                            break;
                        case 'service-not-allowed':
                            errorMessage = 'Speech recognition service not available. Please try again later.';
                            break;
                    }
                    
                    showNotification(errorMessage, 'error');
                    stopVoiceRecording();
                };
                
                recognition.onend = function() {
                    isRecording = false;
                    updateVoiceUI();
                };
                
                // Search recognition
                searchRecognition = new SpeechRecognition();
                searchRecognition.continuous = false;
                searchRecognition.interimResults = false;
                searchRecognition.lang = 'en-US';
                
                searchRecognition.onstart = function() {
                    isSearchRecording = true;
                    updateSearchVoiceUI();
                    showNotification(' Voice search active - say your search term!', 'info');
                };
                
                searchRecognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const searchInput = document.getElementById('searchInput');
                    const mobileSearchInput = document.getElementById('mobileSearchInput');
                    
                    searchInput.value = transcript;
                    mobileSearchInput.value = transcript;
                    
                    // Trigger search
                    handleSearch({ target: searchInput });
                    showNotification(` Searching for: "${transcript}"`, 'success');
                };
                
                searchRecognition.onerror = function(event) {
                    console.error('Search voice recognition error:', event.error);
                    let errorMessage = 'Voice search error occurred.';
                    
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'No speech detected for search. Please speak your search term clearly.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'Microphone not accessible for search. Please check your microphone.';
                            break;
                        case 'not-allowed':
                            showMicrophonePermissionDialog();
                            return;
                        case 'network':
                            errorMessage = 'Network error during voice search. Please check your connection.';
                            break;
                        case 'service-not-allowed':
                            errorMessage = 'Voice search service not available. Please try again later.';
                            break;
                    }
                    
                    showNotification(errorMessage, 'error');
                    stopVoiceSearch();
                };
                
                searchRecognition.onend = function() {
                    isSearchRecording = false;
                    updateSearchVoiceUI();
                };
            } else {
                // Hide voice buttons if not supported
                const voiceBtn = document.getElementById('voiceBtn');
                const headerVoiceBtn = document.getElementById('headerVoiceBtn');
                if (voiceBtn) voiceBtn.style.display = 'none';
                if (headerVoiceBtn) headerVoiceBtn.style.display = 'none';
                showNotification('Voice features not supported in this browser. Please use Chrome, Edge, or Safari.', 'warning');
                console.warn('Speech recognition not supported in this browser');
            }
        }
        
        async function toggleVoiceRecording() {
            if (!recognition) {
                showNotification('Voice recognition not supported in this browser', 'error');
                return;
            }
            
            if (isRecording) {
                stopVoiceRecording();
            } else {
                // Check microphone permission before starting
                const hasPermission = await requestMicrophonePermission();
                if (hasPermission) {
                    startVoiceRecording();
                }
            }
        }
        
        function startVoiceRecording() {
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                if (error.name === 'InvalidStateError') {
                    showNotification('Voice recording is already active. Please wait and try again.', 'warning');
                } else {
                    showNotification('Failed to start voice recording. Please try again.', 'error');
                }
            }
        }
        
        function stopVoiceRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
        }
        
        async function toggleVoiceSearch() {
            if (!searchRecognition) {
                showNotification('Voice search not supported in this browser', 'error');
                return;
            }
            
            if (isSearchRecording) {
                stopVoiceSearch();
            } else {
                // Check microphone permission before starting
                const hasPermission = await requestMicrophonePermission();
                if (hasPermission) {
                    startVoiceSearch();
                }
            }
        }
        
        function startVoiceSearch() {
            try {
                searchRecognition.start();
            } catch (error) {
                console.error('Error starting voice search:', error);
                if (error.name === 'InvalidStateError') {
                    showNotification('Voice search is already active. Please wait and try again.', 'warning');
                } else {
                    showNotification('Failed to start voice search. Please try again.', 'error');
                }
            }
        }
        
        function stopVoiceSearch() {
            if (searchRecognition && isSearchRecording) {
                searchRecognition.stop();
            }
        }
        
        function updateSearchVoiceUI() {
            const headerVoiceBtn = document.getElementById('headerVoiceBtn');
            const headerVoiceIcon = document.getElementById('headerVoiceIcon');
            
            if (isSearchRecording) {
                headerVoiceBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                headerVoiceBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
                headerVoiceIcon.className = 'fas fa-stop text-sm';
            } else {
                headerVoiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
                headerVoiceBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                headerVoiceIcon.className = 'fas fa-microphone text-sm';
            }
        }
        
        function updateVoiceUI() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceIcon = document.getElementById('voiceIcon');
            const voiceStatus = document.getElementById('voiceStatus');
            
            if (isRecording) {
                voiceBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                voiceBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
                voiceIcon.className = 'fas fa-stop';
                voiceStatus.classList.remove('hidden');
            } else {
                voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
                voiceBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                voiceIcon.className = 'fas fa-microphone';
                voiceStatus.classList.add('hidden');
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    }"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function logout() {
            currentUser = null;
            notes = [];
            saveToStorage();
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            
            // Reset forms
            document.querySelectorAll('input').forEach(input => input.value = '');
            showLogin();
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userInitial').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Load sample data if no notes exist
            if (notes.length === 0) {
                loadSampleNotes();
            }
            
            renderNotes();
            updateCategories();
        }

        // Note management functions
        function createNote() {
            currentNote = {
                id: 'note_' + Date.now(),
                title: '',
                content: '',
                tags: [],
                category: '',
                color: '#ffffff',
                status: 'draft',
                pinned: false,
                favorite: false,
                encrypted: false,
                priority: 'medium',
                progress: 0,
                dueDate: '',
                location: '',
                collaborators: [],
                enableReminders: false,
                enableCollaboration: false,
                enableVersioning: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            openEditor();
        }

        function editNote(noteId) {
            currentNote = notes.find(note => note.id === noteId);
            if (currentNote) {
                openEditor();
            }
        }

        function openEditor() {
            document.getElementById('noteEditor').classList.remove('hidden');
            
            if (currentNote) {
                document.getElementById('noteTitle').value = currentNote.title;
                document.getElementById('noteContent').value = currentNote.content;
                document.getElementById('noteCategory').value = currentNote.category || '';
                document.getElementById('noteStatus').value = currentNote.status || 'draft';
                document.getElementById('notePriority').value = currentNote.priority || 'medium';
                document.getElementById('noteProgress').value = currentNote.progress || 0;
                document.getElementById('noteDueDate').value = currentNote.dueDate || '';
                document.getElementById('noteLocation').value = currentNote.location || '';
                
                // Update buttons
                const pinBtn = document.getElementById('pinBtn');
                const favoriteBtn = document.getElementById('favoriteBtn');
                const encryptionBadge = document.getElementById('encryptionBadge');
                
                pinBtn.classList.toggle('text-yellow-500', currentNote.pinned);
                favoriteBtn.classList.toggle('text-red-500', currentNote.favorite);
                
                if (currentNote.encrypted) {
                    encryptionBadge.style.display = 'inline-flex';
                } else {
                    encryptionBadge.style.display = 'none';
                }
                
                // Update progress
                updateProgress();
                
                // Update word count
                updateWordCount();
                
                // Render tags and collaborators
                renderNoteTags();
                renderCollaborators();
                
                // Select color
                selectColor(currentNote.color);
                
                // Update checkboxes
                document.getElementById('enableReminders').checked = currentNote.enableReminders || false;
                document.getElementById('enableCollaboration').checked = currentNote.enableCollaboration || false;
                document.getElementById('enableVersioning').checked = currentNote.enableVersioning || false;
                document.getElementById('enableEncryption').checked = currentNote.encrypted || false;
            }
        }

        function closeEditor() {
            // Stop voice recording if active
            if (isRecording) {
                stopVoiceRecording();
            }
            
            document.getElementById('noteEditor').classList.add('hidden');
            currentNote = null;
        }

        function saveNote() {
            if (!currentNote) return;
            
            currentNote.title = document.getElementById('noteTitle').value || 'Untitled';
            currentNote.content = document.getElementById('noteContent').value;
            currentNote.category = document.getElementById('noteCategory').value;
            currentNote.status = document.getElementById('noteStatus').value;
            currentNote.priority = document.getElementById('notePriority').value;
            currentNote.progress = parseInt(document.getElementById('noteProgress').value);
            currentNote.dueDate = document.getElementById('noteDueDate').value;
            currentNote.location = document.getElementById('noteLocation').value;
            currentNote.enableReminders = document.getElementById('enableReminders').checked;
            currentNote.enableCollaboration = document.getElementById('enableCollaboration').checked;
            currentNote.enableVersioning = document.getElementById('enableVersioning').checked;
            currentNote.encrypted = document.getElementById('enableEncryption').checked;
            currentNote.updatedAt = new Date().toISOString();
            
            // Add or update note
            const existingIndex = notes.findIndex(note => note.id === currentNote.id);
            if (existingIndex >= 0) {
                notes[existingIndex] = currentNote;
            } else {
                notes.push(currentNote);
            }
            
            updateLastSaved();
            saveToStorage();
            renderNotes();
            updateCategories();
            updateAnalytics();
            
            showNotification('Note saved successfully!', 'success');
            closeEditor();
        }

        function autoSave() {
            if (currentNote && (document.getElementById('noteTitle').value || document.getElementById('noteContent').value)) {
                saveNote();
            }
        }

        function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(note => note.id !== noteId);
                saveToStorage();
                renderNotes();
                updateCategories();
            }
        }

        function togglePin(noteId = null) {
            const targetNote = noteId ? notes.find(note => note.id === noteId) : currentNote;
            if (targetNote) {
                targetNote.pinned = !targetNote.pinned;
                targetNote.updatedAt = new Date().toISOString();
                
                if (!noteId) {
                    // Update pin button in editor
                    const pinBtn = document.getElementById('pinBtn');
                    pinBtn.classList.toggle('text-yellow-500', targetNote.pinned);
                }
                
                saveToStorage();
                renderNotes();
            }
        }

        function duplicateNote(noteId) {
            const originalNote = notes.find(note => note.id === noteId);
            if (originalNote) {
                const duplicatedNote = {
                    ...originalNote,
                    id: 'note_' + Date.now(),
                    title: originalNote.title + ' (Copy)',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                notes.push(duplicatedNote);
                saveToStorage();
                renderNotes();
            }
        }

        // Tag management
        function addTag() {
            const tagInput = document.getElementById('tagInput');
            const tagText = tagInput.value.trim();
            
            if (tagText && currentNote && !currentNote.tags.includes(tagText)) {
                currentNote.tags.push(tagText);
                tagInput.value = '';
                renderNoteTags();
            }
        }

        function removeTag(tag) {
            if (currentNote) {
                currentNote.tags = currentNote.tags.filter(t => t !== tag);
                renderNoteTags();
            }
        }

        function renderNoteTags() {
            const container = document.getElementById('noteTags');
            container.innerHTML = '';
            
            if (currentNote && currentNote.tags) {
                currentNote.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag text-white px-2 py-1 rounded-full text-sm flex items-center gap-1';
                    tagElement.innerHTML = `
                        ${tag}
                        <button onclick="removeTag('${tag}')" class="hover:bg-white/20 rounded-full w-4 h-4 flex items-center justify-center">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;
                    container.appendChild(tagElement);
                });
            }
        }

        // Color selection
        function selectColor(color) {
            if (currentNote) {
                currentNote.color = color;
                
                // Update color selection UI
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.querySelector(`[data-color="${color}"]`).classList.add('selected');
            }
        }

        // Search and filter functions
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            renderNotes(query);
        }

        function filterNotes(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'theme-bg-tertiary');
            });
            event.target.classList.add('active', 'theme-bg-tertiary');
            
            renderNotes();
        }

        function sortNotes() {
            currentSort = document.getElementById('sortSelect').value;
            renderNotes();
        }

        function renderNotes(searchQuery = '') {
            const container = document.getElementById('notesGrid');
            const emptyState = document.getElementById('emptyState');
            
            // Filter notes
            let filteredNotes = notes.filter(note => {
                // Search filter
                if (searchQuery) {
                    const matchesSearch = note.title.toLowerCase().includes(searchQuery) ||
                                        note.content.toLowerCase().includes(searchQuery) ||
                                        note.tags.some(tag => tag.toLowerCase().includes(searchQuery));
                    if (!matchesSearch) return false;
                }
                
                // Status filter
                switch (currentFilter) {
                    case 'pinned':
                        return note.pinned;
                    case 'archived':
                        return note.status === 'archived';
                    case 'drafts':
                        return note.status === 'draft';
                    default:
                        return note.status !== 'archived';
                }
            });
            
            // Sort notes
            filteredNotes.sort((a, b) => {
                switch (currentSort) {
                    case 'created':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    default: // updated
                        return new Date(b.updatedAt) - new Date(a.updatedAt);
                }
            });
            
            // Show/hide empty state
            if (filteredNotes.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
            
            // Render notes
            container.innerHTML = '';
            filteredNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = `note-card theme-border border rounded-lg p-4 cursor-pointer transition-all hover:shadow-lg ${isGridView ? '' : 'flex items-start gap-4'}`;
                noteElement.style.backgroundColor = note.color;
                
                const textColor = getContrastColor(note.color);
                noteElement.style.color = textColor;
                
                noteElement.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-lg truncate flex-1" style="color: ${textColor};">${note.title || 'Untitled'}</h3>
                        <div class="flex items-center gap-1 ml-2">
                            ${note.pinned ? '<i class="fas fa-thumbtack text-yellow-600"></i>' : ''}
                            <div class="relative">
                                <button onclick="toggleNoteMenu(event, '${note.id}')" class="p-1 rounded hover:bg-black/10 transition-colors" style="color: ${textColor};">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="noteMenu_${note.id}" class="hidden absolute right-0 mt-1 w-40 theme-bg-secondary theme-border border rounded-lg shadow-lg py-1 z-10">
                                    <button onclick="editNote('${note.id}')" class="w-full text-left px-3 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                        <i class="fas fa-edit mr-2"></i>Edit
                                    </button>
                                    <button onclick="togglePin('${note.id}')" class="w-full text-left px-3 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                        <i class="fas fa-thumbtack mr-2"></i>${note.pinned ? 'Unpin' : 'Pin'}
                                    </button>
                                    <button onclick="duplicateNote('${note.id}')" class="w-full text-left px-3 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors">
                                        <i class="fas fa-copy mr-2"></i>Duplicate
                                    </button>
                                    <button onclick="deleteNote('${note.id}')" class="w-full text-left px-3 py-2 text-red-500 hover:theme-bg-tertiary transition-colors">
                                        <i class="fas fa-trash mr-2"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm mb-3 line-clamp-3" style="color: ${textColor}; opacity: 0.8;">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</p>
                    <div class="flex items-center justify-between text-xs" style="color: ${textColor}; opacity: 0.7;">
                        <div class="flex items-center gap-2">
                            ${note.category ? `<span class="px-2 py-1 rounded-full bg-black/10">${note.category}</span>` : ''}
                            ${note.tags.slice(0, 2).map(tag => `<span class="px-2 py-1 rounded-full bg-black/10">#${tag}</span>`).join('')}
                            ${note.tags.length > 2 ? `<span class="px-2 py-1 rounded-full bg-black/10">+${note.tags.length - 2}</span>` : ''}
                        </div>
                        <span>${formatDate(note.updatedAt)}</span>
                    </div>
                `;
                
                noteElement.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        editNote(note.id);
                    }
                });
                
                container.appendChild(noteElement);
            });
        }

        function toggleNoteMenu(event, noteId) {
            event.stopPropagation();
            
            // Close all other menus
            document.querySelectorAll('[id^="noteMenu_"]').forEach(menu => {
                if (menu.id !== `noteMenu_${noteId}`) {
                    menu.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById(`noteMenu_${noteId}`);
            menu.classList.toggle('hidden');
        }

        // Close note menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[id^="noteMenu_"]') && !e.target.closest('button[onclick^="toggleNoteMenu"]')) {
                document.querySelectorAll('[id^="noteMenu_"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        // UI functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            // Toggle sidebar visibility
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
            
            // Prevent body scroll when sidebar is open on mobile
            if (window.innerWidth < 1024) { // lg breakpoint
                if (sidebar.classList.contains('-translate-x-full')) {
                    document.body.style.overflow = 'auto';
                } else {
                    document.body.style.overflow = 'hidden';
                }
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            // Close sidebar
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (isDarkMode) {
                body.classList.remove('light');
                body.classList.add('dark');
                themeIcon.className = 'fas fa-sun';
            } else {
                body.classList.remove('dark');
                body.classList.add('light');
                themeIcon.className = 'fas fa-moon';
            }
            
            saveToStorage();
        }

        function toggleView() {
            isGridView = !isGridView;
            const viewIcon = document.getElementById('viewIcon');
            const container = document.getElementById('notesGrid');
            
            if (isGridView) {
                viewIcon.className = 'fas fa-th-large';
                container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            } else {
                viewIcon.className = 'fas fa-list';
                container.className = 'space-y-4';
            }
            
            renderNotes();
        }

        function updateCategories() {
            const container = document.getElementById('categoriesList');
            const categories = [...new Set(notes.map(note => note.category).filter(Boolean))];
            
            container.innerHTML = '';
            categories.forEach(category => {
                const count = notes.filter(note => note.category === category && note.status !== 'archived').length;
                const categoryElement = document.createElement('button');
                categoryElement.className = 'w-full text-left px-3 py-2 rounded-lg theme-text-primary hover:theme-bg-tertiary transition-colors flex items-center justify-between';
                categoryElement.innerHTML = `
                    <span><i class="fas fa-folder mr-2"></i>${category}</span>
                    <span class="text-xs theme-text-secondary">${count}</span>
                `;
                categoryElement.onclick = () => filterByCategory(category);
                container.appendChild(categoryElement);
            });
        }

        function filterByCategory(category) {
            const searchInput = document.getElementById('searchInput');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            searchInput.value = `category:${category}`;
            mobileSearchInput.value = `category:${category}`;
            
            const filteredNotes = notes.filter(note => note.category === category && note.status !== 'archived');
            renderFilteredNotes(filteredNotes);
        }

        function renderFilteredNotes(filteredNotes) {
            const container = document.getElementById('notesGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredNotes.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
            
            container.innerHTML = '';
            filteredNotes.forEach(note => {
                // Same rendering logic as renderNotes
                const noteElement = document.createElement('div');
                noteElement.className = `note-card theme-border border rounded-lg p-4 cursor-pointer transition-all hover:shadow-lg`;
                noteElement.style.backgroundColor = note.color;
                
                const textColor = getContrastColor(note.color);
                noteElement.style.color = textColor;
                
                noteElement.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-lg truncate flex-1" style="color: ${textColor};">${note.title || 'Untitled'}</h3>
                        <div class="flex items-center gap-1 ml-2">
                            ${note.pinned ? '<i class="fas fa-thumbtack text-yellow-600"></i>' : ''}
                        </div>
                    </div>
                    <p class="text-sm mb-3 line-clamp-3" style="color: ${textColor}; opacity: 0.8;">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</p>
                    <div class="flex items-center justify-between text-xs" style="color: ${textColor}; opacity: 0.7;">
                        <div class="flex items-center gap-2">
                            ${note.category ? `<span class="px-2 py-1 rounded-full bg-black/10">${note.category}</span>` : ''}
                            ${note.tags.slice(0, 2).map(tag => `<span class="px-2 py-1 rounded-full bg-black/10">#${tag}</span>`).join('')}
                        </div>
                        <span>${formatDate(note.updatedAt)}</span>
                    </div>
                `;
                
                noteElement.addEventListener('click', () => editNote(note.id));
                container.appendChild(noteElement);
            });
        }

        // Export functionality
        function exportNotes() {
            const exportData = {
                user: currentUser,
                notes: notes,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `notes-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Today';
            if (diffDays === 2) return 'Yesterday';
            if (diffDays <= 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString();
        }

        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }

        // Storage functions
        function saveToStorage() {
            const data = {
                currentUser,
                notes,
                isDarkMode,
                currentFilter,
                currentSort,
                isGridView,
                workspaces,
                chatMessages,
                comments,
                sharedNotes
            };
            localStorage.setItem('notesApp', JSON.stringify(data));
        }

        function loadFromStorage() {
            const data = localStorage.getItem('notesApp');
            if (data) {
                const parsed = JSON.parse(data);
                currentUser = parsed.currentUser;
                notes = parsed.notes || [];
                isDarkMode = parsed.isDarkMode || false;
                currentFilter = parsed.currentFilter || 'all';
                currentSort = parsed.currentSort || 'updated';
                isGridView = parsed.isGridView !== false;
                workspaces = parsed.workspaces || [];
                chatMessages = parsed.chatMessages || [];
                comments = parsed.comments || [];
                sharedNotes = parsed.sharedNotes || [];
                
                // Apply theme
                if (isDarkMode) {
                    document.body.classList.remove('light');
                    document.body.classList.add('dark');
                    document.getElementById('themeIcon').className = 'fas fa-sun';
                }
            }
        }

        function loadSampleNotes() {
            notes = [
                {
                    id: 'note_sample_1',
                    title: 'Welcome to NotesApp!',
                    content: 'This is your first note. You can edit, delete, pin, and organize your notes with tags and categories. Try creating a new note or exploring the features!',
                    tags: ['welcome', 'tutorial'],
                    category: 'personal',
                    color: '#c7d2fe',
                    status: 'published',
                    pinned: true,
                    favorite: false,
                    encrypted: false,
                    priority: 'medium',
                    progress: 100,
                    dueDate: null,
                    location: '',
                    collaborators: [],
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    updatedAt: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'note_sample_2',
                    title: 'Project Ideas',
                    content: 'Build a mobile app\nCreate a portfolio website\nLearn TypeScript\nContribute to open source',
                    tags: ['projects', 'coding'],
                    category: 'work',
                    color: '#bbf7d0',
                    status: 'published',
                    pinned: false,
                    favorite: true,
                    encrypted: false,
                    priority: 'high',
                    progress: 25,
                    dueDate: null,
                    location: '',
                    collaborators: [],
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    updatedAt: new Date(Date.now() - 172800000).toISOString()
                },
                {
                    id: 'note_sample_3',
                    title: 'Shopping List',
                    content: 'Groceries:\n- Milk\n- Bread\n- Eggs\n- Fruits\n- Vegetables\n\nOther:\n- Batteries\n- Light bulbs',
                    tags: ['shopping', 'todo'],
                    category: 'personal',
                    color: '#fef3c7',
                    status: 'published',
                    pinned: false,
                    favorite: false,
                    encrypted: false,
                    priority: 'low',
                    progress: 0,
                    dueDate: null,
                    location: 'Grocery Store',
                    collaborators: [],
                    createdAt: new Date(Date.now() - 259200000).toISOString(),
                    updatedAt: new Date(Date.now() - 259200000).toISOString()
                }
            ];
            
            // Load sample templates
            templates = [
                {
                    id: 'template_1',
                    name: 'Meeting Notes',
                    content: '# Meeting Notes\n\n**Date:** \n**Attendees:** \n**Agenda:** \n\n## Discussion Points\n\n## Action Items\n\n## Next Steps\n',
                    category: 'meeting',
                    tags: ['meeting', 'template']
                },
                {
                    id: 'template_2',
                    name: 'Daily Journal',
                    content: '# Daily Journal - [Date]\n\n## Today\'s Highlights\n\n## Challenges\n\n## Lessons Learned\n\n## Tomorrow\'s Goals\n',
                    category: 'journal',
                    tags: ['journal', 'daily', 'template']
                },
                {
                    id: 'template_3',
                    name: 'Project Planning',
                    content: '# Project: [Name]\n\n## Objective\n\n## Timeline\n\n## Resources Needed\n\n## Milestones\n\n## Risks & Mitigation\n',
                    category: 'project',
                    tags: ['project', 'planning', 'template']
                }
            ];
            
            // Load sample habits
            habits = [
                {
                    id: 'habit_1',
                    name: 'Daily Writing',
                    description: 'Write at least 500 words daily',
                    streak: 7,
                    completedDays: Array(30).fill(false).map((_, i) => i < 7 ? true : Math.random() > 0.7)
                },
                {
                    id: 'habit_2',
                    name: 'Note Review',
                    description: 'Review and organize notes',
                    streak: 3,
                    completedDays: Array(30).fill(false).map((_, i) => i < 3 ? true : Math.random() > 0.8)
                }
            ];
            
            updateAnalytics();
            saveToStorage();
        }

        // Advanced Feature Functions
        
        // Quick Capture
        function showQuickCapture() {
            document.getElementById('quickCaptureModal').classList.remove('hidden');
            document.getElementById('quickCaptureText').focus();
        }
        
        function closeQuickCapture() {
            document.getElementById('quickCaptureModal').classList.add('hidden');
            document.getElementById('quickCaptureText').value = '';
        }
        
        function saveQuickCapture() {
            const text = document.getElementById('quickCaptureText').value.trim();
            if (text) {
                const quickNote = {
                    id: 'note_' + Date.now(),
                    title: text.split('\n')[0].substring(0, 50) + (text.length > 50 ? '...' : ''),
                    content: text,
                    tags: ['quick-capture'],
                    category: 'personal',
                    color: '#ffffff',
                    status: 'draft',
                    pinned: false,
                    favorite: false,
                    encrypted: false,
                    priority: 'medium',
                    progress: 0,
                    dueDate: null,
                    location: '',
                    collaborators: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                notes.unshift(quickNote);
                saveToStorage();
                renderNotes();
                updateAnalytics();
                closeQuickCapture();
                showNotification('Quick note saved!', 'success');
            }
        }
        
        function showQuickNote() {
            showQuickCapture();
        }
        
        // Notifications
        function showNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('hidden');
            
            // Hide notification badge
            document.getElementById('notificationBadge').classList.add('hidden');
        }
        
        function closeNotifications() {
            document.getElementById('notificationsPanel').classList.add('hidden');
        }
        
        // Focus Mode
        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            const icon = document.getElementById('focusModeIcon');
            const sidebar = document.getElementById('sidebar');
            const header = document.querySelector('header');
            
            if (isFocusMode) {
                icon.className = 'fas fa-eye-slash';
                sidebar.style.display = 'none';
                header.style.display = 'none';
                document.body.classList.add('focus-mode');
                showNotification('Focus mode enabled', 'info');
            } else {
                icon.className = 'fas fa-eye';
                sidebar.style.display = 'block';
                header.style.display = 'block';
                document.body.classList.remove('focus-mode');
                showNotification('Focus mode disabled', 'info');
            }
        }
        
        // AI Assistant
        function showAIAssistant() {
            document.getElementById('aiAssistantPanel').classList.remove('hidden');
        }
        
        function closeAIAssistant() {
            document.getElementById('aiAssistantPanel').classList.add('hidden');
        }
        
        function applyAISuggestion(type) {
            switch(type) {
                case 1:
                    const content = document.getElementById('noteContent');
                    content.value += '\n\n## Implementation Timeline\n- Phase 1: Planning (Week 1-2)\n- Phase 2: Development (Week 3-6)\n- Phase 3: Testing (Week 7-8)\n- Phase 4: Deployment (Week 9)';
                    break;
                case 2:
                    showNotification('Grammar corrections applied!', 'success');
                    break;
                case 3:
                    if (currentNote) {
                        currentNote.tags = [...new Set([...currentNote.tags, 'productivity', 'planning', 'goals'])];
                        renderNoteTags();
                    }
                    break;
            }
            showNotification('AI suggestion applied!', 'success');
        }
        
        // Rich Text Formatting
        function formatText(format) {
            const textarea = document.getElementById('noteContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let formattedText = '';
            
            switch(format) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'underline':
                    formattedText = `<u>${selectedText}</u>`;
                    break;
                case 'strikethrough':
                    formattedText = `~~${selectedText}~~`;
                    break;
                case 'h1':
                    formattedText = `# ${selectedText}`;
                    break;
                case 'h2':
                    formattedText = `## ${selectedText}`;
                    break;
                case 'h3':
                    formattedText = `### ${selectedText}`;
                    break;
                case 'ul':
                    formattedText = `- ${selectedText}`;
                    break;
                case 'ol':
                    formattedText = `1. ${selectedText}`;
                    break;
                case 'quote':
                    formattedText = `> ${selectedText}`;
                    break;
                case 'code':
                    formattedText = `\`${selectedText}\``;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
        }
        
        // Drawing Tool
        function showDrawingTool() {
            const drawingArea = document.getElementById('drawingArea');
            drawingArea.classList.toggle('hidden');
            
            if (!drawingArea.classList.contains('hidden')) {
                initializeDrawing();
            }
        }
        
        function initializeDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            drawingContext = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            drawingContext.beginPath();
            drawingContext.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = e.target.getBoundingClientRect();
            const color = document.getElementById('drawColor').value;
            const size = document.getElementById('drawSize').value;
            
            drawingContext.lineWidth = size;
            drawingContext.lineCap = 'round';
            drawingContext.strokeStyle = color;
            
            drawingContext.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            drawingContext.stroke();
            drawingContext.beginPath();
            drawingContext.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function stopDrawing() {
            isDrawing = false;
            drawingContext.beginPath();
        }
        
        function clearCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            drawingContext.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function saveDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            const dataURL = canvas.toDataURL();
            
            // Add drawing to note content
            const textarea = document.getElementById('noteContent');
            textarea.value += `\n\n[Drawing: ${new Date().toLocaleString()}]\n`;
            
            showNotification('Drawing saved to note!', 'success');
        }
        
        // Enhanced Note Features
        function toggleFavorite() {
            if (currentNote) {
                currentNote.favorite = !currentNote.favorite;
                const btn = document.getElementById('favoriteBtn');
                btn.classList.toggle('text-red-500', currentNote.favorite);
                saveToStorage();
            }
        }
        
        function shareNote() {
            if (currentNote) {
                const shareData = {
                    title: currentNote.title,
                    text: currentNote.content,
                    url: window.location.href
                };
                
                if (navigator.share) {
                    navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(`${currentNote.title}\n\n${currentNote.content}`);
                    showNotification('Note copied to clipboard!', 'success');
                }
            }
        }
        
        function toggleEncryption() {
            if (currentNote) {
                currentNote.encrypted = !currentNote.encrypted;
                const badge = document.getElementById('encryptionBadge');
                
                if (currentNote.encrypted) {
                    badge.style.display = 'inline-flex';
                    showNotification('Note encrypted!', 'success');
                } else {
                    badge.style.display = 'none';
                    showNotification('Note decrypted!', 'info');
                }
                
                saveToStorage();
            }
        }
        
        function showVersionHistory() {
            showNotification('Version history feature coming soon!', 'info');
        }
        
        // Analytics and Stats
        function updateAnalytics() {
            analytics.totalNotes = notes.length;
            analytics.wordsWritten = notes.reduce((total, note) => total + note.content.split(' ').length, 0);
            
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            analytics.notesThisWeek = notes.filter(note => new Date(note.createdAt) > oneWeekAgo).length;
            
            analytics.averageWordsPerNote = analytics.totalNotes > 0 ? Math.round(analytics.wordsWritten / analytics.totalNotes) : 0;
            
            // Update UI
            document.getElementById('totalNotesCount').textContent = analytics.totalNotes;
            document.getElementById('weekNotesCount').textContent = analytics.notesThisWeek;
            document.getElementById('totalWordsCount').textContent = analytics.wordsWritten.toLocaleString();
        }
        
        function updateWordCount() {
            const content = document.getElementById('noteContent').value;
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
            document.getElementById('wordCount').textContent = `${wordCount} words`;
        }
        
        function updateLastSaved() {
            document.getElementById('lastSaved').textContent = `Saved ${new Date().toLocaleTimeString()}`;
        }
        
        // Progress tracking
        function updateProgress() {
            const progress = document.getElementById('noteProgress').value;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = progress + '%';
            progressText.textContent = progress;
            
            if (currentNote) {
                currentNote.progress = parseInt(progress);
            }
        }
        
        // Insert functions
        function insertTable() {
            const textarea = document.getElementById('noteContent');
            const table = '\n| Column 1 | Column 2 | Column 3 |\n|----------|----------|----------|\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |\n';
            insertAtCursor(textarea, table);
        }
        
        function insertLink() {
            const url = prompt('Enter URL:');
            const text = prompt('Enter link text:') || url;
            if (url) {
                const link = `[${text}](${url})`;
                insertAtCursor(document.getElementById('noteContent'), link);
            }
        }
        
        function insertImage() {
            const url = prompt('Enter image URL:');
            const alt = prompt('Enter alt text:') || 'Image';
            if (url) {
                const image = `![${alt}](${url})`;
                insertAtCursor(document.getElementById('noteContent'), image);
            }
        }
        
        function insertCheckbox() {
            const text = prompt('Enter checkbox text:') || 'Task';
            const checkbox = `- [ ] ${text}`;
            insertAtCursor(document.getElementById('noteContent'), checkbox);
        }
        
        function insertDate() {
            const date = new Date().toLocaleDateString();
            insertAtCursor(document.getElementById('noteContent'), date);
        }
        
        function setReminder() {
            const datetime = prompt('Enter reminder date and time (YYYY-MM-DD HH:MM):');
            if (datetime) {
                const reminder = `\n Reminder: ${datetime}\n`;
                insertAtCursor(document.getElementById('noteContent'), reminder);
                showNotification('Reminder set!', 'success');
            }
        }
        
        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + text.length, start + text.length);
        }
        
        // Advanced Tools
        function showKanbanBoard() {
            showNotification('Kanban Board feature coming soon!', 'info');
        }
        
        function showCalendarView() {
            showNotification('Calendar View feature coming soon!', 'info');
        }
        
        function showMindMap() {
            showNotification('Mind Map feature coming soon!', 'info');
        }
        
        function showHabitTracker() {
            showNotification('Habit Tracker feature coming soon!', 'info');
        }
        
        function showPomodoroTimer() {
            showNotification('Pomodoro Timer feature coming soon!', 'info');
        }
        
        function showAnalytics() {
            showNotification('Analytics Dashboard feature coming soon!', 'info');
        }
        
        function showTemplates() {
            showNotification('Templates feature coming soon!', 'info');
        }
        
        function showCollaboration() {
            document.getElementById('collaborationPanel').classList.remove('hidden');
        }
        
        function showSettings() {
            showNotification('Settings panel coming soon!', 'info');
        }
        
        function showKeyboardShortcuts() {
            showNotification('Keyboard shortcuts: Ctrl+N (New), Ctrl+S (Save), Ctrl+F (Search)', 'info');
        }
        
        function importNotes() {
            showNotification('Import feature coming soon!', 'info');
        }
        
        function showBackup() {
            showNotification('Backup & Sync feature coming soon!', 'info');
        }
        
        function showHelp() {
            showNotification('Help & Support feature coming soon!', 'info');
        }
        
        // Collaboration Functions
        function closeCollaboration() {
            document.getElementById('collaborationPanel').classList.add('hidden');
        }
        
        function switchCollabTab(tab) {
            currentCollabTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.collab-tab').forEach(btn => {
                btn.classList.remove('theme-text-primary', 'border-purple-600', 'bg-purple-50', 'dark:bg-purple-900/20');
                btn.classList.add('theme-text-secondary', 'border-transparent');
            });
            
            event.target.classList.remove('theme-text-secondary', 'border-transparent');
            event.target.classList.add('theme-text-primary', 'border-purple-600', 'bg-purple-50', 'dark:bg-purple-900/20');
            
            // Hide all tabs
            document.getElementById('sharedNotesTab').classList.add('hidden');
            document.getElementById('commentsTab').classList.add('hidden');
            document.getElementById('permissionsTab').classList.add('hidden');
            document.getElementById('chatTab').classList.add('hidden');
            
            // Show selected tab
            switch(tab) {
                case 'shared':
                    document.getElementById('sharedNotesTab').classList.remove('hidden');
                    loadSharedNotes();
                    break;
                case 'comments':
                    document.getElementById('commentsTab').classList.remove('hidden');
                    loadComments();
                    break;
                case 'permissions':
                    document.getElementById('permissionsTab').classList.remove('hidden');
                    loadPermissions();
                    break;
                case 'chat':
                    document.getElementById('chatTab').classList.remove('hidden');
                    loadChatMessages();
                    break;
            }
        }
        
        function loadSharedNotes() {
            const container = document.getElementById('sharedNotesList');
            
            // Sample shared notes
            const sampleSharedNotes = [
                {
                    id: 'shared_1',
                    title: 'Project Roadmap 2024',
                    content: 'Q1: Planning phase, Q2: Development, Q3: Testing, Q4: Launch',
                    sharedBy: 'Sarah Kim',
                    sharedWith: ['Mike Johnson', 'Anna Lee', 'You'],
                    lastModified: '2 hours ago',
                    permissions: 'edit',
                    color: '#c7d2fe'
                },
                {
                    id: 'shared_2',
                    title: 'Meeting Notes - Sprint Planning',
                    content: 'Sprint goals, user stories, and task assignments for the upcoming sprint.',
                    sharedBy: 'Mike Johnson',
                    sharedWith: ['Sarah Kim', 'David Wilson', 'You'],
                    lastModified: '1 day ago',
                    permissions: 'comment',
                    color: '#bbf7d0'
                },
                {
                    id: 'shared_3',
                    title: 'Design System Guidelines',
                    content: 'Color palette, typography, component library, and design principles.',
                    sharedBy: 'Anna Lee',
                    sharedWith: ['Team Design', 'You'],
                    lastModified: '3 days ago',
                    permissions: 'view',
                    color: '#fef3c7'
                }
            ];
            
            container.innerHTML = '';
            sampleSharedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-card theme-border border rounded-lg p-4 cursor-pointer transition-all hover:shadow-lg';
                noteElement.style.backgroundColor = note.color;
                
                const textColor = getContrastColor(note.color);
                noteElement.style.color = textColor;
                
                noteElement.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-semibold text-lg truncate flex-1" style="color: ${textColor};">${note.title}</h4>
                        <div class="flex items-center gap-1 ml-2">
                            <span class="px-2 py-1 rounded-full text-xs bg-black/10" style="color: ${textColor};">
                                ${note.permissions === 'edit' ? ' Edit' : note.permissions === 'comment' ? ' Comment' : ' View'}
                            </span>
                        </div>
                    </div>
                    <p class="text-sm mb-3 line-clamp-2" style="color: ${textColor}; opacity: 0.8;">${note.content}</p>
                    <div class="flex items-center justify-between text-xs" style="color: ${textColor}; opacity: 0.7;">
                        <div class="flex items-center gap-2">
                            <span>Shared by ${note.sharedBy}</span>
                            <span></span>
                            <span>${note.sharedWith.length} members</span>
                        </div>
                        <span>${note.lastModified}</span>
                    </div>
                `;
                
                noteElement.addEventListener('click', () => openSharedNote(note.id));
                container.appendChild(noteElement);
            });
        }
        
        function loadComments() {
            const container = document.getElementById('commentsList');
            
            // Sample comments
            const sampleComments = [
                {
                    id: 'comment_1',
                    noteTitle: 'Project Roadmap 2024',
                    author: 'Sarah Kim',
                    avatar: 'SK',
                    content: 'I think we should add more buffer time for the testing phase. What do you think?',
                    timestamp: '2 hours ago',
                    replies: 2,
                    isUnread: true
                },
                {
                    id: 'comment_2',
                    noteTitle: 'Meeting Notes - Sprint Planning',
                    author: 'Mike Johnson',
                    avatar: 'MJ',
                    content: 'Great notes! Can we add the acceptance criteria for user story #23?',
                    timestamp: '5 hours ago',
                    replies: 0,
                    isUnread: true
                },
                {
                    id: 'comment_3',
                    noteTitle: 'Design System Guidelines',
                    author: 'Anna Lee',
                    avatar: 'AL',
                    content: 'Updated the color palette based on our accessibility review. Please check the contrast ratios.',
                    timestamp: '1 day ago',
                    replies: 3,
                    isUnread: false
                }
            ];
            
            container.innerHTML = '';
            sampleComments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = `p-4 theme-bg-tertiary rounded-lg ${comment.isUnread ? 'border-l-4 border-purple-600' : ''}`;
                
                commentElement.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                            ${comment.avatar}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-medium theme-text-primary">${comment.author}</span>
                                <span class="text-xs theme-text-secondary">commented on</span>
                                <span class="text-xs font-medium theme-text-primary">${comment.noteTitle}</span>
                                ${comment.isUnread ? '<span class="w-2 h-2 bg-purple-600 rounded-full"></span>' : ''}
                            </div>
                            <p class="theme-text-primary text-sm mb-2">${comment.content}</p>
                            <div class="flex items-center gap-4 text-xs theme-text-secondary">
                                <span>${comment.timestamp}</span>
                                ${comment.replies > 0 ? `<span>${comment.replies} replies</span>` : ''}
                                <button onclick="replyToComment('${comment.id}')" class="text-purple-600 hover:text-purple-700">Reply</button>
                                <button onclick="markCommentRead('${comment.id}')" class="text-purple-600 hover:text-purple-700">Mark as read</button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(commentElement);
            });
        }
        
        function loadPermissions() {
            const container = document.getElementById('permissionsList');
            
            // Load workspaces from storage or create default ones
            if (workspaces.length === 0) {
                workspaces = [
                    {
                        id: 'workspace_1',
                        name: 'Product Team',
                        description: 'Main workspace for product development',
                        members: [
                            { id: 'user_1', name: 'Sarah Kim', email: 'sarah@company.com', role: 'Admin', avatar: 'SK' },
                            { id: 'user_2', name: 'Mike Johnson', email: 'mike@company.com', role: 'Editor', avatar: 'MJ' },
                            { id: 'user_3', name: 'Anna Lee', email: 'anna@company.com', role: 'Editor', avatar: 'AL' },
                            { id: 'user_4', name: 'David Wilson', email: 'david@company.com', role: 'Viewer', avatar: 'DW' },
                            { id: 'current_user', name: currentUser?.name || 'You', email: currentUser?.email || 'you@company.com', role: 'Admin', avatar: currentUser?.name?.charAt(0) || 'U' }
                        ],
                        notes: 24,
                        createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                        settings: {
                            allowInvites: true,
                            defaultPermission: 'Editor',
                            requireApproval: false
                        }
                    },
                    {
                        id: 'workspace_2',
                        name: 'Design Team',
                        description: 'Collaborative space for design work',
                        members: [
                            { id: 'user_3', name: 'Anna Lee', email: 'anna@company.com', role: 'Admin', avatar: 'AL' },
                            { id: 'user_5', name: 'Emma Rodriguez', email: 'emma@company.com', role: 'Editor', avatar: 'ER' },
                            { id: 'current_user', name: currentUser?.name || 'You', email: currentUser?.email || 'you@company.com', role: 'Editor', avatar: currentUser?.name?.charAt(0) || 'U' }
                        ],
                        notes: 12,
                        createdAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                        settings: {
                            allowInvites: false,
                            defaultPermission: 'Viewer',
                            requireApproval: true
                        }
                    }
                ];
            }
            
            container.innerHTML = '';
            workspaces.forEach(workspace => {
                const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role || 'Viewer';
                const workspaceElement = document.createElement('div');
                workspaceElement.className = 'theme-bg-tertiary rounded-lg p-6 mb-6';
                
                workspaceElement.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h4 class="font-semibold theme-text-primary text-lg">${workspace.name}</h4>
                            <p class="theme-text-secondary text-sm">${workspace.description}</p>
                            <p class="theme-text-secondary text-xs mt-1">Created ${formatDate(workspace.createdAt)}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${
                            currentUserRole === 'Admin' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                            currentUserRole === 'Editor' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                            'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                        }">${currentUserRole}</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold theme-text-primary">${workspace.members.length}</div>
                            <div class="text-xs theme-text-secondary">Members</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold theme-text-primary">${workspace.notes}</div>
                            <div class="text-xs theme-text-secondary">Notes</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold theme-text-primary">${Math.floor(workspace.notes / 5)}</div>
                            <div class="text-xs theme-text-secondary">Projects</div>
                        </div>
                    </div>
                    
                    <!-- Members List -->
                    <div class="mb-4">
                        <h5 class="font-medium theme-text-primary mb-2 text-sm">Members (${workspace.members.length})</h5>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${workspace.members.map(member => `
                                <div class="flex items-center justify-between py-1">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                            ${member.avatar}
                                        </div>
                                        <div>
                                            <div class="text-sm theme-text-primary">${member.name}</div>
                                            <div class="text-xs theme-text-secondary">${member.email}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${currentUserRole === 'Admin' && member.id !== 'current_user' ? `
                                            <select onchange="changeUserRole('${workspace.id}', '${member.id}', this.value)" class="text-xs px-2 py-1 rounded theme-bg-secondary theme-border border">
                                                <option value="Admin" ${member.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                                <option value="Editor" ${member.role === 'Editor' ? 'selected' : ''}>Editor</option>
                                                <option value="Viewer" ${member.role === 'Viewer' ? 'selected' : ''}>Viewer</option>
                                            </select>
                                            <button onclick="removeMember('${workspace.id}', '${member.id}')" class="text-red-500 hover:text-red-700 text-xs p-1" title="Remove member">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : `
                                            <span class="text-xs px-2 py-1 rounded theme-bg-secondary">${member.role}</span>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Workspace Settings -->
                    ${currentUserRole === 'Admin' ? `
                        <div class="mb-4 p-3 theme-bg-secondary rounded-lg">
                            <h5 class="font-medium theme-text-primary mb-2 text-sm">Workspace Settings</h5>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" ${workspace.settings.allowInvites ? 'checked' : ''} 
                                           onchange="updateWorkspaceSetting('${workspace.id}', 'allowInvites', this.checked)"
                                           class="rounded">
                                    <span class="theme-text-primary">Allow members to invite others</span>
                                </label>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" ${workspace.settings.requireApproval ? 'checked' : ''} 
                                           onchange="updateWorkspaceSetting('${workspace.id}', 'requireApproval', this.checked)"
                                           class="rounded">
                                    <span class="theme-text-primary">Require approval for new members</span>
                                </label>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="theme-text-primary">Default permission:</span>
                                    <select onchange="updateWorkspaceSetting('${workspace.id}', 'defaultPermission', this.value)" 
                                            class="text-xs px-2 py-1 rounded theme-bg-tertiary theme-border border">
                                        <option value="Admin" ${workspace.settings.defaultPermission === 'Admin' ? 'selected' : ''}>Admin</option>
                                        <option value="Editor" ${workspace.settings.defaultPermission === 'Editor' ? 'selected' : ''}>Editor</option>
                                        <option value="Viewer" ${workspace.settings.defaultPermission === 'Viewer' ? 'selected' : ''}>Viewer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center gap-2">
                        ${currentUserRole === 'Admin' ? `
                            <button onclick="manageWorkspace('${workspace.id}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                <i class="fas fa-cog mr-2"></i>Manage Members
                            </button>
                            <button onclick="inviteToWorkspace('${workspace.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                <i class="fas fa-user-plus mr-2"></i>Invite
                            </button>
                        ` : `
                            <button onclick="viewWorkspaceDetails('${workspace.id}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                <i class="fas fa-eye mr-2"></i>View Details
                            </button>
                        `}
                        <button onclick="leaveWorkspace('${workspace.id}')" class="px-4 py-2 theme-text-secondary hover:theme-text-primary border theme-border rounded-lg transition-colors text-sm">
                            <i class="fas fa-sign-out-alt mr-2"></i>Leave
                        </button>
                    </div>
                `;
                
                container.appendChild(workspaceElement);
            });
        }
        
        function loadChatMessages() {
            const container = document.getElementById('chatMessages');
            
            // Initialize chat messages if empty
            if (chatMessages.length === 0) {
                chatMessages = [
                    {
                        id: 'msg_1',
                        author: 'Sarah Kim',
                        avatar: 'SK',
                        content: 'Hey team! Just finished updating the project roadmap. Please take a look when you have a chance.',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                        isOwn: false,
                        workspaceId: 'workspace_1'
                    },
                    {
                        id: 'msg_2',
                        author: currentUser?.name || 'You',
                        avatar: currentUser?.name?.charAt(0)?.toUpperCase() || 'U',
                        content: 'Thanks Sarah! I\'ll review it this afternoon.',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000 + 2 * 60 * 1000).toISOString(),
                        isOwn: true,
                        workspaceId: 'workspace_1'
                    },
                    {
                        id: 'msg_3',
                        author: 'Mike Johnson',
                        avatar: 'MJ',
                        content: 'Looks great! I added some comments on the Q3 timeline.',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000 + 15 * 60 * 1000).toISOString(),
                        isOwn: false,
                        workspaceId: 'workspace_1'
                    },
                    {
                        id: 'msg_4',
                        author: 'Anna Lee',
                        avatar: 'AL',
                        content: 'Perfect timing! I was just about to ask about the design review schedule.',
                        timestamp: new Date(Date.now() - 1.5 * 60 * 60 * 1000).toISOString(),
                        isOwn: false,
                        workspaceId: 'workspace_2'
                    },
                    {
                        id: 'msg_5',
                        author: 'Emma Rodriguez',
                        avatar: 'ER',
                        content: 'I\'ve uploaded the latest design mockups to the shared folder. Let me know what you think!',
                        timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                        isOwn: false,
                        workspaceId: 'workspace_2'
                    }
                ];
            }
            
            container.innerHTML = '';
            
            // Group messages by date
            const messagesByDate = {};
            chatMessages.forEach(message => {
                const date = new Date(message.timestamp).toDateString();
                if (!messagesByDate[date]) {
                    messagesByDate[date] = [];
                }
                messagesByDate[date].push(message);
            });
            
            // Render messages grouped by date
            Object.keys(messagesByDate).sort((a, b) => new Date(a) - new Date(b)).forEach(date => {
                // Add date separator
                const dateElement = document.createElement('div');
                dateElement.className = 'text-center my-4';
                dateElement.innerHTML = `
                    <div class="inline-block px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-full text-xs theme-text-secondary">
                        ${formatChatDate(date)}
                    </div>
                `;
                container.appendChild(dateElement);
                
                // Add messages for this date
                messagesByDate[date].forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `flex items-start gap-3 mb-4 ${message.isOwn ? 'flex-row-reverse' : ''}`;
                    messageElement.dataset.messageId = message.id;
                    
                    const timeString = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    messageElement.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br ${
                            message.isOwn ? 'from-purple-400 to-purple-600' : 'from-blue-400 to-indigo-500'
                        } rounded-full flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">
                            ${message.avatar}
                        </div>
                        <div class="flex-1 min-w-0 ${message.isOwn ? 'text-right' : ''}">
                            <div class="flex items-center gap-2 mb-1 ${message.isOwn ? 'justify-end' : ''}">
                                <span class="font-medium theme-text-primary text-sm">${message.author}</span>
                                <span class="text-xs theme-text-secondary">${timeString}</span>
                                ${message.isOwn ? `
                                    <div class="relative">
                                        <button onclick="showMessageOptions('${message.id}')" class="text-xs theme-text-secondary hover:theme-text-primary p-1 rounded">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <div id="messageOptions_${message.id}" class="hidden absolute right-0 mt-1 w-32 theme-bg-secondary theme-border border rounded-lg shadow-lg py-1 z-10">
                                            <button onclick="editMessage('${message.id}')" class="w-full text-left px-3 py-2 theme-text-primary hover:theme-bg-tertiary transition-colors text-xs">
                                                <i class="fas fa-edit mr-2"></i>Edit
                                            </button>
                                            <button onclick="deleteMessage('${message.id}')" class="w-full text-left px-3 py-2 text-red-500 hover:theme-bg-tertiary transition-colors text-xs">
                                                <i class="fas fa-trash mr-2"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="inline-block px-4 py-2 rounded-lg max-w-xs break-words ${
                                message.isOwn 
                                    ? 'bg-purple-600 text-white' 
                                    : 'theme-bg-tertiary theme-text-primary'
                            }" ${message.isEdited ? 'title="This message was edited"' : ''}>
                                <p class="text-sm whitespace-pre-wrap" id="messageContent_${message.id}">${message.content}</p>
                                ${message.isEdited ? '<span class="text-xs opacity-70">(edited)</span>' : ''}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(messageElement);
                });
            });
            
            // Add typing indicator if someone is typing
            if (window.typingUsers && window.typingUsers.length > 0) {
                const typingElement = document.createElement('div');
                typingElement.className = 'flex items-start gap-3 mb-4';
                typingElement.id = 'typingIndicator';
                
                typingElement.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-gray-400 to-gray-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                        <i class="fas fa-ellipsis-h animate-pulse"></i>
                    </div>
                    <div class="flex-1">
                        <div class="inline-block px-4 py-2 rounded-lg theme-bg-tertiary theme-text-primary">
                            <p class="text-sm text-gray-500">
                                ${window.typingUsers.join(', ')} ${window.typingUsers.length === 1 ? 'is' : 'are'} typing...
                            </p>
                        </div>
                    </div>
                `;
                
                container.appendChild(typingElement);
            }
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function formatChatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Collaboration Actions
        function shareNewNote() {
            if (notes.length === 0) {
                showNotification('Create some notes first to share them!', 'info');
                return;
            }
            
            const noteToShare = notes[0]; // Share the first note as example
            showNotification(`Shared "${noteToShare.title}" with team members!`, 'success');
            loadSharedNotes(); // Refresh the shared notes list
        }
        
        function openSharedNote(noteId) {
            showNotification('Opening shared note in collaborative editor...', 'info');
            // In a real app, this would open the note in a collaborative editor
        }
        
        function inviteMembers() {
            document.getElementById('inviteMembersModal').classList.remove('hidden');
        }
        
        function closeInviteModal() {
            document.getElementById('inviteMembersModal').classList.add('hidden');
            document.getElementById('inviteEmails').value = '';
            document.getElementById('inviteMessage').value = '';
        }
        
        function sendInvitations() {
            const emails = document.getElementById('inviteEmails').value.trim();
            const permission = document.getElementById('invitePermission').value;
            const message = document.getElementById('inviteMessage').value.trim();
            
            if (!emails) {
                showNotification('Please enter at least one email address', 'error');
                return;
            }
            
            const emailList = emails.split('\n').filter(email => email.trim());
            showNotification(`Invitations sent to ${emailList.length} team members!`, 'success');
            closeInviteModal();
        }
        
        function startVideoCall(userId) {
            const userNames = {
                'sarah': 'Sarah Kim',
                'mike': 'Mike Johnson',
                'anna': 'Anna Lee'
            };
            
            const userName = userNames[userId] || 'Team Member';
            const userInitials = userName.split(' ').map(n => n[0]).join('');
            
            document.getElementById('calleeName').textContent = userName;
            document.getElementById('calleeNameLarge').textContent = userName;
            document.getElementById('calleeAvatar').textContent = userInitials;
            document.getElementById('calleeAvatarLarge').textContent = userInitials;
            
            document.getElementById('videoCallModal').classList.remove('hidden');
            isCallActive = true;
            
            // Simulate call progression
            setTimeout(() => {
                document.getElementById('callStatus').textContent = 'Ringing...';
                document.getElementById('callStatusLarge').textContent = 'Ringing...';
            }, 1000);
            
            setTimeout(() => {
                document.getElementById('callStatus').textContent = 'Connected';
                document.getElementById('callStatusLarge').textContent = 'Connected';
                showNotification(`Connected to ${userName}!`, 'success');
            }, 3000);
        }
        
        function endCall() {
            document.getElementById('videoCallModal').classList.add('hidden');
            isCallActive = false;
            isMuted = false;
            isVideoOn = true;
            
            // Reset UI
            document.getElementById('muteBtn').innerHTML = '<i class="fas fa-microphone"></i>';
            document.getElementById('videoBtn').innerHTML = '<i class="fas fa-video"></i>';
            
            showNotification('Call ended', 'info');
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('muteBtn');
            
            if (isMuted) {
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                btn.classList.add('bg-red-600');
                btn.classList.remove('bg-gray-700');
                showNotification('Microphone muted', 'info');
            } else {
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.remove('bg-red-600');
                btn.classList.add('bg-gray-700');
                showNotification('Microphone unmuted', 'info');
            }
        }
        
        function toggleVideo() {
            isVideoOn = !isVideoOn;
            const btn = document.getElementById('videoBtn');
            
            if (!isVideoOn) {
                btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                btn.classList.add('bg-red-600');
                btn.classList.remove('bg-gray-700');
                showNotification('Camera turned off', 'info');
            } else {
                btn.innerHTML = '<i class="fas fa-video"></i>';
                btn.classList.remove('bg-red-600');
                btn.classList.add('bg-gray-700');
                showNotification('Camera turned on', 'info');
            }
        }
        
        function shareScreen() {
            showNotification('Screen sharing started!', 'success');
        }
        
        function sendMessage(userId) {
            const userNames = {
                'sarah': 'Sarah Kim',
                'mike': 'Mike Johnson',
                'anna': 'Anna Lee'
            };
            
            const userName = userNames[userId] || 'Team Member';
            showNotification(`Opening chat with ${userName}...`, 'info');
            
            // Switch to chat tab
            switchCollabTab('chat');
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Create new message object
            const newMessage = {
                id: 'msg_' + Date.now(),
                author: currentUser?.name || 'You',
                avatar: currentUser?.name?.charAt(0)?.toUpperCase() || 'U',
                content: message,
                timestamp: new Date().toISOString(),
                isOwn: true,
                workspaceId: 'workspace_1' // Default to first workspace
            };
            
            // Add to chat messages array
            chatMessages.push(newMessage);
            
            // Clear input
            input.value = '';
            
            // Stop typing indicator
            clearTypingIndicator();
            
            // Reload chat to show new message
            loadChatMessages();
            
            // Save to storage
            saveToStorage();
            
            // Simulate responses from team members
            simulateTeamResponse(message);
        }
        
        function simulateTeamResponse(originalMessage) {
            const responses = [
                { author: 'Sarah Kim', avatar: 'SK', responses: ['Thanks for the update! ', 'Got it, will check it out!', 'Sounds good to me!', 'Perfect timing!'] },
                { author: 'Mike Johnson', avatar: 'MJ', responses: ['Agreed!', 'Nice work!', 'I\'ll take a look', 'Thanks for sharing!'] },
                { author: 'Anna Lee', avatar: 'AL', responses: ['Great idea!', 'Love it! ', 'This looks promising', 'Excellent point!'] }
            ];
            
            // Randomly select a team member to respond
            const responder = responses[Math.floor(Math.random() * responses.length)];
            const response = responder.responses[Math.floor(Math.random() * responder.responses.length)];
            
            // Show typing indicator
            showTypingIndicator(responder.author);
            
            // Send response after 2-4 seconds
            setTimeout(() => {
                const responseMessage = {
                    id: 'msg_' + Date.now(),
                    author: responder.author,
                    avatar: responder.avatar,
                    content: response,
                    timestamp: new Date().toISOString(),
                    isOwn: false,
                    workspaceId: 'workspace_1'
                };
                
                chatMessages.push(responseMessage);
                clearTypingIndicator();
                loadChatMessages();
                saveToStorage();
            }, Math.random() * 2000 + 2000);
        }
        
        function showTypingIndicator(userName) {
            if (!window.typingUsers) window.typingUsers = [];
            if (!window.typingUsers.includes(userName)) {
                window.typingUsers.push(userName);
                loadChatMessages();
            }
        }
        
        function clearTypingIndicator() {
            window.typingUsers = [];
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        function showMessageOptions(messageId) {
            // Close all other message option menus
            document.querySelectorAll('[id^="messageOptions_"]').forEach(menu => {
                if (menu.id !== `messageOptions_${messageId}`) {
                    menu.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById(`messageOptions_${messageId}`);
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
        
        function editMessage(messageId) {
            const message = chatMessages.find(m => m.id === messageId);
            if (!message || !message.isOwn) return;
            
            const newContent = prompt('Edit your message:', message.content);
            if (newContent && newContent.trim() && newContent.trim() !== message.content) {
                message.content = newContent.trim();
                message.isEdited = true;
                message.editedAt = new Date().toISOString();
                
                saveToStorage();
                loadChatMessages();
                showNotification('Message edited successfully!', 'success');
            }
            
            // Hide menu
            document.getElementById(`messageOptions_${messageId}`).classList.add('hidden');
        }
        
        function deleteMessage(messageId) {
            const message = chatMessages.find(m => m.id === messageId);
            if (!message || !message.isOwn) return;
            
            if (confirm('Are you sure you want to delete this message?')) {
                chatMessages = chatMessages.filter(m => m.id !== messageId);
                saveToStorage();
                loadChatMessages();
                showNotification('Message deleted successfully!', 'success');
            }
            
            // Hide menu
            document.getElementById(`messageOptions_${messageId}`).classList.add('hidden');
        }
        
        // Enhanced chat input with typing indicator
        let typingTimeout;
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    // Show that user is typing (in a real app, this would notify other users)
                    clearTimeout(typingTimeout);
                    
                    // Clear typing indicator after 3 seconds of no typing
                    typingTimeout = setTimeout(() => {
                        // In a real app, this would notify other users that user stopped typing
                    }, 3000);
                });
            }
        });
        
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,application/pdf,.doc,.docx,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // In a real app, you would upload the file to a server
                    // For demo purposes, we'll just show the file name
                    const fileName = file.name;
                    const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                    
                    const fileMessage = {
                        id: 'msg_' + Date.now(),
                        author: currentUser?.name || 'You',
                        avatar: currentUser?.name?.charAt(0)?.toUpperCase() || 'U',
                        content: ` Shared file: ${fileName} (${fileSize})`,
                        timestamp: new Date().toISOString(),
                        isOwn: true,
                        workspaceId: 'workspace_1',
                        isFile: true,
                        fileName: fileName,
                        fileSize: fileSize
                    };
                    
                    chatMessages.push(fileMessage);
                    saveToStorage();
                    loadChatMessages();
                    showNotification(`File "${fileName}" shared successfully!`, 'success');
                }
            };
            input.click();
        }
        
        function startVoiceMessage() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Voice messages not supported in this browser', 'error');
                return;
            }
            
            // For demo purposes, simulate a voice message
            const voiceMessage = {
                id: 'msg_' + Date.now(),
                author: currentUser?.name || 'You',
                avatar: currentUser?.name?.charAt(0)?.toUpperCase() || 'U',
                content: ' Voice message (0:15)',
                timestamp: new Date().toISOString(),
                isOwn: true,
                workspaceId: 'workspace_1',
                isVoice: true,
                duration: '0:15'
            };
            
            chatMessages.push(voiceMessage);
            saveToStorage();
            loadChatMessages();
            showNotification('Voice message sent!', 'success');
        }
        
        function replyToComment(commentId) {
            showNotification('Reply feature coming soon!', 'info');
        }
        
        function markCommentRead(commentId) {
            showNotification('Comment marked as read!', 'success');
            loadComments(); // Refresh comments
        }
        
        function markAllCommentsRead() {
            showNotification('All comments marked as read!', 'success');
            loadComments(); // Refresh comments
        }
        
        function createWorkspace() {
            const name = prompt('Enter workspace name:');
            if (!name) return;
            
            const description = prompt('Enter workspace description (optional):') || '';
            
            const newWorkspace = {
                id: 'workspace_' + Date.now(),
                name: name,
                description: description,
                members: [
                    { id: 'current_user', name: currentUser?.name || 'You', email: currentUser?.email || 'you@company.com', role: 'Admin', avatar: currentUser?.name?.charAt(0) || 'U' }
                ],
                notes: 0,
                createdAt: new Date().toISOString(),
                settings: {
                    allowInvites: true,
                    defaultPermission: 'Editor',
                    requireApproval: false
                }
            };
            
            workspaces.push(newWorkspace);
            saveToStorage();
            showNotification(`Workspace "${name}" created successfully!`, 'success');
            loadPermissions();
        }
        
        function manageWorkspace(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role;
            if (currentUserRole !== 'Admin') {
                showNotification('Only admins can manage workspace members', 'error');
                return;
            }
            
            showNotification(`Managing ${workspace.name} - Use the controls above to add/remove members and change roles`, 'info');
        }
        
        function inviteToWorkspace(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role;
            if (currentUserRole !== 'Admin' && !workspace.settings.allowInvites) {
                showNotification('You do not have permission to invite members to this workspace', 'error');
                return;
            }
            
            const email = prompt('Enter email address to invite:');
            if (!email) return;
            
            const name = prompt('Enter member name:') || email.split('@')[0];
            
            // Check if user already exists
            if (workspace.members.find(m => m.email === email)) {
                showNotification('User is already a member of this workspace', 'error');
                return;
            }
            
            const newMember = {
                id: 'user_' + Date.now(),
                name: name,
                email: email,
                role: workspace.settings.defaultPermission,
                avatar: name.split(' ').map(n => n[0]).join('').toUpperCase()
            };
            
            workspace.members.push(newMember);
            saveToStorage();
            showNotification(`Invited ${name} to ${workspace.name}!`, 'success');
            loadPermissions();
        }
        
        function viewWorkspaceDetails(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role || 'Viewer';
            
            // Create detailed workspace view modal
            const modal = document.createElement('div');
            modal.id = 'workspaceDetailsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="theme-bg-primary rounded-lg w-full max-w-2xl max-h-[90vh] overflow-hidden">
                    <div class="theme-bg-secondary px-6 py-4 flex items-center justify-between border-b theme-border">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-users text-purple-600 text-xl"></i>
                            <h3 class="text-xl font-semibold theme-text-primary">${workspace.name}</h3>
                        </div>
                        <button onclick="closeWorkspaceDetails()" class="theme-text-secondary hover:theme-text-primary">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                        <!-- Workspace Overview -->
                        <div class="mb-6">
                            <h4 class="font-semibold theme-text-primary mb-3">Workspace Overview</h4>
                            <div class="theme-bg-tertiary rounded-lg p-4">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="text-sm theme-text-secondary">Name</label>
                                        <p class="font-medium theme-text-primary">${workspace.name}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm theme-text-secondary">Your Role</label>
                                        <p class="font-medium theme-text-primary">
                                            <span class="px-2 py-1 rounded-full text-xs ${
                                                currentUserRole === 'Admin' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                                                currentUserRole === 'Editor' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                                                'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                                            }">${currentUserRole}</span>
                                        </p>
                                    </div>
                                    <div>
                                        <label class="text-sm theme-text-secondary">Created</label>
                                        <p class="font-medium theme-text-primary">${formatDate(workspace.createdAt)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm theme-text-secondary">Total Notes</label>
                                        <p class="font-medium theme-text-primary">${workspace.notes}</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm theme-text-secondary">Description</label>
                                    <p class="theme-text-primary">${workspace.description || 'No description provided'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <div class="mb-6">
                            <h4 class="font-semibold theme-text-primary mb-3">Statistics</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center theme-bg-tertiary rounded-lg p-4">
                                    <div class="text-2xl font-bold theme-text-primary">${workspace.members.length}</div>
                                    <div class="text-sm theme-text-secondary">Members</div>
                                </div>
                                <div class="text-center theme-bg-tertiary rounded-lg p-4">
                                    <div class="text-2xl font-bold theme-text-primary">${workspace.notes}</div>
                                    <div class="text-sm theme-text-secondary">Notes</div>
                                </div>
                                <div class="text-center theme-bg-tertiary rounded-lg p-4">
                                    <div class="text-2xl font-bold theme-text-primary">${Math.floor(workspace.notes / 5)}</div>
                                    <div class="text-sm theme-text-secondary">Projects</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Members List -->
                        <div class="mb-6">
                            <h4 class="font-semibold theme-text-primary mb-3">Members (${workspace.members.length})</h4>
                            <div class="theme-bg-tertiary rounded-lg p-4">
                                <div class="space-y-3 max-h-48 overflow-y-auto">
                                    ${workspace.members.map(member => `
                                        <div class="flex items-center justify-between py-2">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                                    ${member.avatar}
                                                </div>
                                                <div>
                                                    <div class="font-medium theme-text-primary">${member.name}</div>
                                                    <div class="text-sm theme-text-secondary">${member.email}</div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="px-2 py-1 rounded-full text-xs ${
                                                    member.role === 'Admin' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                                                    member.role === 'Editor' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                                                    'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                                                }">${member.role}</span>
                                                ${member.id === 'current_user' ? '<span class="text-xs theme-text-secondary">(You)</span>' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Workspace Settings (if visible) -->
                        <div class="mb-6">
                            <h4 class="font-semibold theme-text-primary mb-3">Workspace Settings</h4>
                            <div class="theme-bg-tertiary rounded-lg p-4">
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="theme-text-primary">Member Invitations</span>
                                        <span class="text-sm px-2 py-1 rounded-full ${workspace.settings.allowInvites ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                            ${workspace.settings.allowInvites ? 'Allowed' : 'Restricted'}
                                        </span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="theme-text-primary">New Member Approval</span>
                                        <span class="text-sm px-2 py-1 rounded-full ${workspace.settings.requireApproval ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}">
                                            ${workspace.settings.requireApproval ? 'Required' : 'Automatic'}
                                        </span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="theme-text-primary">Default Permission</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                            ${workspace.settings.defaultPermission}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="mb-6">
                            <h4 class="font-semibold theme-text-primary mb-3">Recent Activity</h4>
                            <div class="theme-bg-tertiary rounded-lg p-4">
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3">
                                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mt-0.5">
                                            <i class="fas fa-edit text-white text-xs"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm theme-text-primary">Sarah edited "Project Timeline"</p>
                                            <p class="text-xs theme-text-secondary">2 hours ago</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mt-0.5">
                                            <i class="fas fa-comment text-white text-xs"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm theme-text-primary">Mike added a comment</p>
                                            <p class="text-xs theme-text-secondary">5 hours ago</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center mt-0.5">
                                            <i class="fas fa-user-plus text-white text-xs"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm theme-text-primary">Anna joined the workspace</p>
                                            <p class="text-xs theme-text-secondary">1 day ago</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 border-t theme-border flex justify-end gap-3">
                        <button onclick="closeWorkspaceDetails()" class="px-4 py-2 theme-text-secondary hover:theme-text-primary border theme-border rounded-lg transition-colors">
                            Close
                        </button>
                        ${currentUserRole === 'Admin' ? `
                            <button onclick="closeWorkspaceDetails(); manageWorkspace('${workspaceId}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-cog mr-2"></i>Manage
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeWorkspaceDetails() {
            const modal = document.getElementById('workspaceDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function changeUserRole(workspaceId, userId, newRole) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role;
            if (currentUserRole !== 'Admin') {
                showNotification('Only admins can change user roles', 'error');
                return;
            }
            
            const member = workspace.members.find(m => m.id === userId);
            if (member) {
                const oldRole = member.role;
                member.role = newRole;
                saveToStorage();
                showNotification(`Changed ${member.name}'s role from ${oldRole} to ${newRole}`, 'success');
            }
        }
        
        function removeMember(workspaceId, userId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role;
            if (currentUserRole !== 'Admin') {
                showNotification('Only admins can remove members', 'error');
                return;
            }
            
            const member = workspace.members.find(m => m.id === userId);
            if (!member) return;
            
            if (confirm(`Are you sure you want to remove ${member.name} from this workspace?`)) {
                workspace.members = workspace.members.filter(m => m.id !== userId);
                saveToStorage();
                showNotification(`Removed ${member.name} from workspace`, 'success');
                loadPermissions();
            }
        }
        
        function updateWorkspaceSetting(workspaceId, setting, value) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const currentUserRole = workspace.members.find(m => m.id === 'current_user')?.role;
            if (currentUserRole !== 'Admin') {
                showNotification('Only admins can change workspace settings', 'error');
                return;
            }
            
            workspace.settings[setting] = value;
            saveToStorage();
            
            const settingNames = {
                allowInvites: 'member invitation permissions',
                requireApproval: 'approval requirement',
                defaultPermission: 'default permission level'
            };
            
            showNotification(`Updated ${settingNames[setting]} for ${workspace.name}`, 'success');
        }
        
        function leaveWorkspace(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) {
                showNotification('Workspace not found', 'error');
                return;
            }
            
            const currentUserMember = workspace.members.find(m => m.id === 'current_user');
            if (!currentUserMember) {
                showNotification('You are not a member of this workspace', 'error');
                return;
            }
            
            // Check if user is the only admin
            const admins = workspace.members.filter(m => m.role === 'Admin');
            if (currentUserMember.role === 'Admin' && admins.length === 1) {
                // Show detailed modal for admin transfer
                showAdminTransferModal(workspaceId);
                return;
            }
            
            // Show confirmation modal
            showLeaveWorkspaceModal(workspaceId);
        }
        
        function showLeaveWorkspaceModal(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const modal = document.createElement('div');
            modal.id = 'leaveWorkspaceModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="theme-bg-primary rounded-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center">
                                <i class="fas fa-sign-out-alt text-red-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold theme-text-primary">Leave Workspace</h3>
                                <p class="text-sm theme-text-secondary">Are you sure you want to leave?</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="theme-bg-tertiary rounded-lg p-4">
                                <h4 class="font-medium theme-text-primary mb-2">${workspace.name}</h4>
                                <p class="text-sm theme-text-secondary mb-3">${workspace.description || 'No description'}</p>
                                
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="theme-text-secondary">Your role:</span>
                                        <span class="theme-text-primary font-medium">${workspace.members.find(m => m.id === 'current_user')?.role}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="theme-text-secondary">Members:</span>
                                        <span class="theme-text-primary font-medium">${workspace.members.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="theme-text-secondary">Notes:</span>
                                        <span class="theme-text-primary font-medium">${workspace.notes}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                                <div>
                                    <h4 class="font-medium text-yellow-800 dark:text-yellow-200">Warning</h4>
                                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                                        After leaving, you will lose access to:
                                    </p>
                                    <ul class="text-sm text-yellow-700 dark:text-yellow-300 mt-2 space-y-1 list-disc list-inside">
                                        <li>All shared notes in this workspace</li>
                                        <li>Team chat history and discussions</li>
                                        <li>Collaborative projects and comments</li>
                                        <li>Workspace-specific settings and permissions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeLeaveWorkspaceModal()" class="flex-1 px-4 py-2 theme-text-secondary hover:theme-text-primary border theme-border rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button onclick="confirmLeaveWorkspace('${workspaceId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>Leave Workspace
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showAdminTransferModal(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            const otherMembers = workspace.members.filter(m => m.id !== 'current_user');
            
            const modal = document.createElement('div');
            modal.id = 'adminTransferModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="theme-bg-primary rounded-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-full flex items-center justify-center">
                                <i class="fas fa-crown text-orange-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold theme-text-primary">Transfer Admin Rights</h3>
                                <p class="text-sm theme-text-secondary">You're the only admin</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4 mb-4">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-orange-600 mt-0.5"></i>
                                    <div>
                                        <h4 class="font-medium text-orange-800 dark:text-orange-200">Admin Transfer Required</h4>
                                        <p class="text-sm text-orange-700 dark:text-orange-300 mt-1">
                                            As the only admin, you must transfer admin rights to another member before leaving the workspace.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            ${otherMembers.length > 0 ? `
                                <div>
                                    <label class="block text-sm font-medium theme-text-primary mb-2">
                                        Select new admin:
                                    </label>
                                    <select id="newAdminSelect" class="w-full px-3 py-2 theme-bg-tertiary theme-border border rounded-lg theme-text-primary focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="">Choose a member...</option>
                                        ${otherMembers.map(member => `
                                            <option value="${member.id}">${member.name} (${member.role})</option>
                                        `).join('')}
                                    </select>
                                </div>
                            ` : `
                                <div class="text-center py-4">
                                    <i class="fas fa-users text-4xl theme-text-secondary mb-2"></i>
                                    <p class="theme-text-primary font-medium">No other members</p>
                                    <p class="text-sm theme-text-secondary">You cannot leave as you're the only member. Consider inviting others first.</p>
                                </div>
                            `}
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeAdminTransferModal()" class="flex-1 px-4 py-2 theme-text-secondary hover:theme-text-primary border theme-border rounded-lg transition-colors">
                                Cancel
                            </button>
                            ${otherMembers.length > 0 ? `
                                <button onclick="transferAdminAndLeave('${workspaceId}')" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                    <i class="fas fa-crown mr-2"></i>Transfer & Leave
                                </button>
                            ` : `
                                <button onclick="closeAdminTransferModal(); inviteToWorkspace('${workspaceId}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-user-plus mr-2"></i>Invite Members
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeLeaveWorkspaceModal() {
            const modal = document.getElementById('leaveWorkspaceModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function closeAdminTransferModal() {
            const modal = document.getElementById('adminTransferModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function confirmLeaveWorkspace(workspaceId) {
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            // Remove current user from workspace
            workspace.members = workspace.members.filter(m => m.id !== 'current_user');
            
            // If no members left, remove the workspace entirely
            if (workspace.members.length === 0) {
                workspaces = workspaces.filter(w => w.id !== workspaceId);
                showNotification(`Workspace "${workspace.name}" was deleted as no members remained`, 'info');
            } else {
                showNotification(`Successfully left workspace "${workspace.name}"`, 'success');
            }
            
            saveToStorage();
            closeLeaveWorkspaceModal();
            loadPermissions();
        }
        
        function transferAdminAndLeave(workspaceId) {
            const newAdminId = document.getElementById('newAdminSelect').value;
            if (!newAdminId) {
                showNotification('Please select a member to transfer admin rights to', 'error');
                return;
            }
            
            const workspace = workspaces.find(w => w.id === workspaceId);
            if (!workspace) return;
            
            // Find the new admin member
            const newAdmin = workspace.members.find(m => m.id === newAdminId);
            if (!newAdmin) {
                showNotification('Selected member not found', 'error');
                return;
            }
            
            // Transfer admin rights
            newAdmin.role = 'Admin';
            
            // Remove current user
            workspace.members = workspace.members.filter(m => m.id !== 'current_user');
            
            saveToStorage();
            closeAdminTransferModal();
            loadPermissions();
            
            showNotification(`Admin rights transferred to ${newAdmin.name}. You have left the workspace.`, 'success');
        }
        
        // Initialize collaboration data when app loads
        function initializeCollaborationData() {
            // Load sample data
            sharedNotes = [];
            teamMembers = [];
            chatMessages = [];
            comments = [];
            workspaces = [];
            
            // Set up real-time collaboration simulation
            setInterval(() => {
                // Simulate real-time activity updates
                updateCollaborationActivity();
            }, 30000); // Update every 30 seconds
        }
        
        function updateCollaborationActivity() {
            // Simulate random activity updates
            const activities = [
                'Sarah is typing...',
                'Mike viewed "Project Plan"',
                'Anna added a comment',
                'New message in team chat'
            ];
            
            const randomActivity = activities[Math.floor(Math.random() * activities.length)];
            // In a real app, this would update the UI with real-time activity
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c50b6d46546ec5',t:'MTc1NzQwMzcwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
